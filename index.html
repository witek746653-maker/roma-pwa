<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–æ–≤ ‚Äî –º–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>

<link rel="icon" href="favicon.png" type="image/png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ffffff">

<style>
  :root{ --bg:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --panel:#f8fafc; --badge:#fde047; --badgeText:#1f2937 }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:12px/1.25 system-ui,-apple-system,Segoe UI,Roboto}
  .okbar{display:none;position:sticky;top:0;z-index:20;background:#ecfdf5;color:#065f46;border-bottom:1px solid #a7f3d0;padding:6px 10px;font-weight:700}
  .header{position:sticky;top:0;z-index:10;display:grid;grid-template-columns:1fr;gap:6px;padding:6px;border-bottom:1px solid var(--border);background:#fff}
  .bar{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  label{font-size:10px;color:var(--muted)}
  .field{display:flex;gap:4px;flex-direction:column}
  input[type="date"],button{border:1px solid var(--border);background:#fff;border-radius:8px;min-height:28px;padding:4px 8px;font-size:12px}
  button{cursor:pointer}
  .btn{border:1px solid var(--border)}
  .btn-acc{border-color:#c7d2fe}
  .btn-danger{border-color:#fecaca}
  .badge{display:inline-flex;margin-top:2px;align-self:flex-start;background:var(--badge);color:var(--badgeText);border-radius:999px;padding:3px 8px;font-weight:700;font-size:11px;cursor:pointer}
  .center{display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:center}
  .b-chip{border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#fff;display:inline-flex;gap:6px;align-items:center;font-weight:700;font-size:12px;cursor:pointer}
  .b-chip.active{outline:2px solid rgba(99,102,241,.25)}
  .b-actions{display:inline-flex;gap:4px}
  .icon-btn{border:1px solid var(--border);background:#fff;border-radius:6px;padding:2px 5px;font-size:11px}
  .waiters{display:grid;gap:6px}
  .w-section{display:flex;align-items:center;gap:6px}
  .w-title{font-weight:800;color:#475569;font-size:11px}
  .w-row{display:grid;grid-auto-flow:column;grid-template-rows:repeat(2,auto);gap:3px 4px;overflow-x:auto}
  .more-toggle{border:1px dashed #cbd5e1;border-radius:8px;padding:2px 8px;background:#fff;font-size:11px;cursor:pointer}
  .chip{border:1px solid #c7d2fe;border-radius:10px;padding:3px 6px;background:#eef2ff;color:#0b1e4a;display:inline-flex;flex-direction:column;gap:2px;min-width:max-content}
  .chip .top{display:flex;gap:4px;align-items:center}
  .chip .name{font-weight:800;font-size:11px}
  .chip .edit{border:1px solid var(--border);border-radius:6px;padding:0 4px;background:#fff;font-size:10px}
  .chip .del{border:none;background:none;color:#991b1b;font-weight:900;font-size:13px;line-height:1;padding:0 3px}
  .chip .note{font-size:10px;color:#64748b}
  .chip.active{outline:2px solid rgba(99,102,241,.25)}
  .columns{display:grid;gap:6px;padding:6px;grid-template-columns:repeat(3,1fr)}
  details.panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:6px}
  summary{list-style:none;display:flex;gap:6px;align-items:flex-start;cursor:pointer}
  summary::-webkit-details-marker{display:none}
  .hall-title{font-weight:900;font-size:12px;display:flex;gap:6px;align-items:center}
  .hall-total{margin-left:auto;color:#334155;font-size:11px;font-weight:800}
  .hall-brief{margin-left:8px;color:var(--muted);font-size:10px;line-height:1.25;max-width:65%;display:none;white-space:normal}
  details[open] .hall-brief{display:none}
  details.panel:not([open]) .hall-brief.has{display:block}
  .pos-grid{display:grid;gap:6px;margin-top:6px}
  .pos-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px}
  .pos-head{display:flex;gap:6px;align-items:center}
  .pos-title{font-weight:800;font-size:12px;display:flex;gap:6px;align-items:center}
  .counter{margin-left:auto;color:#475569;font-size:11px}
  .slot{display:flex;flex-wrap:wrap;gap:4px;border:1px dashed #e2e8f0;border-radius:8px;padding:6px;min-height:32px}
  .adder{display:flex;gap:6px;align-items:center}
  .adder select{border:1px solid var(--border);border-radius:8px;min-height:26px;padding:2px 6px;font-size:12px;max-width:100%}
  .adder .addBtn{border:1px solid #c7d2fe;background:#eef2ff;border-radius:8px;min-height:26px;padding:2px 8px;font-size:12px;cursor:pointer}
  .assign{display:inline-flex;flex-direction:column;align-items:flex-start;gap:2px;border:1px solid var(--border);border-radius:8px;padding:4px 8px;background:#fafafa}
  .assign .top{display:flex;gap:6px;align-items:center}
  .assign .w-name{font-weight:800;font-size:12px}
  .assign .x{border:none;background:none;color:#991b1b;font-weight:900;font-size:14px;line-height:1;cursor:pointer;padding:0}
  .assign .w-note{font-size:10px;color:#64748b}
  .hall-tools{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;align-items:center}
  .hall-pill{border:1px solid #fde68a;background:#fffbeb;border-radius:999px;padding:2px 8px;font-size:11px;display:inline-flex;gap:6px;align-items:center}
  .hall-pill .tag{background:#fef3c7;border:1px solid #fde68a;border-radius:6px;padding:1px 4px;font-size:10px;color:#92400e}
  .hall-pill .x{border:none;background:none;color:#991b1b;font-weight:900;font-size:14px;line-height:1;cursor:pointer;padding:0}
  .mini{font-size:11px;color:#475569}
  .weak{color:#64748b}
  @media (max-width:430px){
    html,body{font-size:11px}
    input[type="date"],button{min-height:26px;font-size:11px}
    .chip .name{font-size:10px}
    .columns{gap:4px}
    .pos-card{padding:6px}
    .slot{padding:4px}
  }
</style>
</head>
<body>
  <div id="okbar" class="okbar">‚úÖ JS —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–∫—Ç–∏–≤–µ–Ω</div>

  <div class="header">
    <div class="bar">
      <div class="field">
        <label for="date">–î–∞—Ç–∞</label>
        <input id="date" type="date" />
        <span id="shiftBadge" class="badge" title="–°—á–∏—Ç–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏">üë• –í —Å–º–µ–Ω–µ: ‚Äî</span>
      </div>

      <button id="undoBtn" class="btn" title="–û—Ç–º–µ–Ω–∏—Ç—å (Undo)">‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å</button>
      <button id="redoBtn" class="btn" title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å (Redo)">‚Ü∑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>

      <button id="addWaiter" class="btn btn-acc">–î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞</button>

      <button id="shareWA" class="btn btn-acc" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ WhatsApp">WhatsApp</button>
      <button id="shareTG" class="btn btn-acc" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram">Telegram</button>
      <button id="shareMail" class="btn btn-acc" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ Email">Email</button>

      <button id="copy" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>

      <button id="exportBtn" class="btn">–≠–∫—Å–ø–æ—Ä—Ç</button>
      <button id="importBtn" class="btn">–ò–º–ø–æ—Ä—Ç</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">

      <button id="resetDay" class="btn btn-danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button id="statsBtn" class="btn" title="–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
      <button id="installBtn" class="btn" title="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ" style="display:none">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
    </div>

    <div class="center" id="banquetBar" aria-label="–ë–∞–Ω–∫–µ—Ç—ã"></div>

    <div class="waiters">
      <div class="w-section">
        <div class="w-title">1-—è —Å–º–µ–Ω–∞</div>
        <div class="w-row" id="rowPrimary"></div>
      </div>
      <div class="w-section">
        <button id="toggleSecondary" class="more-toggle">2-—è —Å–º–µ–Ω–∞ ‚Üì</button>
        <div class="w-row" id="rowSecondary" style="display:none"></div>
      </div>
    </div>
  </div>

  <div class="columns">
    <div class="col" id="col1"></div>
    <div class="col" id="col2"></div>
    <div class="col" id="col3"></div>
  </div>

  <!-- —à–∞–±–ª–æ–Ω—ã -->
  <template id="chipTpl">
    <div class="chip" tabindex="0">
      <div class="top">
        <span class="name"></span>
        <button class="edit" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">üí¨</button>
        <button class="del" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
      </div>
      <div class="note"></div>
    </div>
  </template>

  <template id="hallTpl">
    <details class="panel" open>
      <summary>
        <span class="hall-title"></span>
        <span class="hall-total"></span>
        <span class="hall-brief"></span>
      </summary>
      <!-- —Å—é–¥–∞ –ø–æ–¥—Ä–∏—Å—É–µ–º .hall-tools –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
      <div class="pos-grid"></div>
    </details>
  </template>

  <template id="posCardTpl">
    <div class="pos-card">
      <div class="pos-head">
        <div class="pos-title"></div>
        <div class="counter"></div>
      </div>
      <div class="adder">
        <select class="pick"><option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞ ‚Äî</option></select>
        <button class="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="slot"></div>
    </div>
  </template>

  <noscript>
    <div style="padding:12px;background:#fee2e2;color:#7f1d1d;border:1px solid #fecaca;margin:8px;border-radius:8px">
      –í –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫–ª—é—á—ë–Ω JavaScript ‚Äî —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å. –í–∫–ª—é—á–∏—Ç–µ JavaScript –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ.
    </div>
  </noscript>

<script>
(function(){
'use strict';

function showOK(){ var el=document.getElementById('okbar'); if(el) el.style.display='block'; }

/* ====== –¥–∞–Ω–Ω—ã–µ ====== */
const UUID=(crypto&&crypto.randomUUID)?()=>crypto.randomUUID():()=>('id-'+Math.random().toString(36).slice(2));
const STORAGE_KEY='rota-compact-v12';
const MAX_AGE_DAYS=60;
const HISTORY_LIMIT=100;

const CHIP_COLORS=[['#E3F2FD','#0b1e4a'],['#FCE7F3','#3e1a36'],['#E8F5E9','#103b1f'],['#FFF3E0','#4a2f0b'],['#F3E8FF','#2e1065'],['#E0F2F1','#083d3b'],['#FFFDE7','#3a3000'],['#F1F5F9','#0f172a'],['#FFE4E6','#4a0b15'],['#EDE7F6','#1f1147']];

const HALL_ICONS={ '–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª':'üèõÔ∏è','–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª':'ü™ë','–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã':'üëë','–í–µ—Ä–∞–Ω–¥–∞':'üåø','–õ–æ—Ñ—Ç':'üè†','–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞':'üç∑' };
const POS_ICONS={
  '–ó–æ–Ω–∞ –æ–∫–Ω–∞':'ü™ü','5-—è –ª–∏–Ω–∏—è':'üìö','–°—Ç–æ–ª—ã 7, 8, 9':'‚òïÔ∏è','–°—Ç–æ–ª—ã 10, 11, 12':'üçΩÔ∏è','–ü–æ–¥–∏—É–º':'ü™ú',
  '–ú–ë–ó':'ü™ë','–ë–æ–ª—å—à–æ–π –í–ò–ü':'üî•','–ú–∞–ª—ã–π –í–ò–ü':'üìö','–ö–∞—é—Ç–∞':'‚öì','–õ–∏–µ–Ω–¥–∞':'üíß','–í–µ—Ä–∞–Ω–¥–∞ 1':'üåø','–í–µ—Ä–∞–Ω–¥–∞ 2':'üö¨','–õ–æ—Ñ—Ç':'üß±','–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞':'üç∑'
};

const CANON_HALLS=[
  {name:'–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª', positions:['–ó–æ–Ω–∞ –æ–∫–Ω–∞','5-—è –ª–∏–Ω–∏—è','–°—Ç–æ–ª—ã 7, 8, 9','–°—Ç–æ–ª—ã 10, 11, 12','–ü–æ–¥–∏—É–º']},
  {name:'–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª', positions:['–ú–ë–ó']},
  {name:'–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã', positions:['–ë–æ–ª—å—à–æ–π –í–ò–ü','–ú–∞–ª—ã–π –í–ò–ü','–ö–∞—é—Ç–∞','–õ–∏–µ–Ω–¥–∞']},
  {name:'–í–µ—Ä–∞–Ω–¥–∞', positions:['–í–µ—Ä–∞–Ω–¥–∞ 1','–í–µ—Ä–∞–Ω–¥–∞ 2']},
  {name:'–õ–æ—Ñ—Ç', positions:['–õ–æ—Ñ—Ç']},
  {name:'–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞', positions:['–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞']}
];
const BANQUET_TYPES={'–î–†':'üéâ –î–†','–°–≤–∞–¥—å–±–∞':'üíç –°–≤–∞–¥—å–±–∞','–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤':'üè¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤','–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è':'üì£ –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è','–î–µ–Ω—å –ø–∞–º—è—Ç–∏':'üïØÔ∏è –î–µ–Ω—å –ø–∞–º—è—Ç–∏','–î—Ä—É–≥–æ–π':'üè∑Ô∏è –î—Ä—É–≥–æ–µ'};
const DEFAULT_PRIMARY=['–í–∏–∫—Ç–æ—Ä','–≠–ª–æ–Ω–∞','–ü–æ–ª–∏–Ω–∞','–ù–∞—Ç–∞–ª—å—è –ß.','–ù–∞—Å—Ç—è','–†–æ–º–∞–Ω'];
const DEFAULT_SECONDARY=['–ò–≥–æ—Ä—å','–ö–∞—Ç—è','–Æ–ª—è','–ù–∞—Ç–∞—à–∞ –í.','–í–æ–≤–∞','–ú–∞—à–∞','–ò–≤–∞–Ω','–ù–∞—Ç–∞—à–∞ –í–µ–ª–∏—á–∫–æ'];

const $=sel=>document.querySelector(sel);
function todayISO(){const tz=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-tz).toISOString().slice(0,10);}
function dateKey(){return $('#date').value || todayISO();}
function weekdayRU(iso){ const d=new Date(iso+'T00:00'); const w=['–≤—Å','–ø–Ω','–≤—Ç','—Å—Ä','—á—Ç','–ø—Ç','—Å–±']; return w[d.getDay()]; }
function fmtDateRU(iso){ const [y,m,d]=iso.split('-'); return `${d}.${m}.${y} (${weekdayRU(iso)})`; }
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY));}catch{return null;} }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

/* ====== –∏—Å—Ç–æ—Ä–∏—è (Undo/Redo) ====== */
const history={undo:[], redo:[]};
function pushHistory(){
  history.undo.push(JSON.stringify(db));
  if(history.undo.length>HISTORY_LIMIT) history.undo.shift();
  history.redo.length=0;
  updateUndoRedoButtons();
}
function undo(){
  if(!history.undo.length) return;
  history.redo.push(JSON.stringify(db));
  const prev=history.undo.pop();
  db=JSON.parse(prev);
  save(); renderAll(); renderShiftAndTotals(); updateUndoRedoButtons();
}
function redo(){
  if(!history.redo.length) return;
  history.undo.push(JSON.stringify(db));
  const next=history.redo.pop();
  db=JSON.parse(next);
  save(); renderAll(); renderShiftAndTotals(); updateUndoRedoButtons();
}
function updateUndoRedoButtons(){
  $('#undoBtn').disabled = history.undo.length===0;
  $('#redoBtn').disabled = history.redo.length===0;
}

/* ====== –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö ====== */
function purgeOldData(){
  const now = new Date(todayISO()+'T00:00');
  ['assignments','notes','banquets','shiftSize','hallExtras'].forEach(key=>{
    const m=db[key]||{};
    for(const k in m){
      const d=new Date(k+'T00:00');
      if((now-d)/(1000*60*60*24) > MAX_AGE_DAYS) delete m[k];
    }
  });
}

/* ====== –±–∞–∑–∞ ====== */
function buildDB(){
  const uniq=[...new Set([...DEFAULT_PRIMARY,...DEFAULT_SECONDARY])].map(n=>({id:UUID(),name:n}));
  return {
    halls: CANON_HALLS.map(h=>({id:UUID(),name:h.name,positions:h.positions.map(n=>({id:UUID(),name:n}))})),
    waiters: uniq,
    metaShifts: { primary:[...DEFAULT_PRIMARY], secondary:[...DEFAULT_SECONDARY] },
    assignments:{}, notes:{}, banquets:{}, shiftSize:{},
    hallExtras:{} // date -> hallId -> {hallBanquets:[], sharedWaiter:null}
  };
}
let db = load() || buildDB();
purgeOldData(); save();

/* ====== –º–∞–ø–ø–∏–Ω–≥ –∏ extras ====== */
function hallsByName(){return Object.fromEntries(db.halls.map(h=>[h.name,h]));}
function dayAss(){const k=dateKey(); if(!db.assignments[k]) db.assignments[k]={}; return db.assignments[k];}
function ensureSlot(hid,pid){const a=dayAss(); if(!a[hid]) a[hid]={}; if(!Array.isArray(a[hid][pid])) a[hid][pid]=[]; return a[hid][pid];}
function notesForDay(){const k=dateKey(); if(!db.notes[k]) db.notes[k]={}; return db.notes[k];}
function getNotes(wid){const m=notesForDay(); return m[wid]||(m[wid]=[])}
function addNote(wid,t){pushHistory(); const a=getNotes(wid); if(!a.includes(t)) a.push(t); save()}
function delNote(wid,i){pushHistory(); const a=getNotes(wid); a.splice(i,1); save()}
function waiterById(id){return db.waiters.find(w=>w.id===id)}
function waiterIdByName(name){return db.waiters.find(w=>w.name===name)?.id}
function colorForWaiter(id){const i=Math.max(0, db.waiters.findIndex(w=>w.id===id)); const [bg,fg]=CHIP_COLORS[i%CHIP_COLORS.length]; return {bg,fg}}
function banquetsForDay(){const k=dateKey(); if(!db.banquets[k]) db.banquets[k]=[]; return db.banquets[k];}
function banquetById(id){return banquetsForDay().find(b=>b.id===id)}
function uniqueWaitersAll(){
  const ass=dayAss(); const ids=new Set();
  for(const hid in ass){ for(const pid in ass[hid]){ (ass[hid][pid]||[]).forEach(e=>{ if(e.k==='w') ids.add(e.id); }); } }
  // –æ–±—â–∏–π –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –í–ò–ü–æ–≤
  const extras = hallExtrasForDay();
  for(const hid in extras){ const ex = extras[hid]; if(ex && ex.sharedWaiter) ids.add(ex.sharedWaiter); }
  return ids;
}

/* extras */
function hallExtrasForDay(){ const k=dateKey(); if(!db.hallExtras[k]) db.hallExtras[k]={}; return db.hallExtras[k]; }
function getHallExtra(hid){ const map=hallExtrasForDay(); if(!map[hid]) map[hid]={hallBanquets:[], sharedWaiter:null}; return map[hid]; }
function addHallBanquet(hid,bid){ pushHistory(); const ex=getHallExtra(hid); if(!ex.hallBanquets.includes(bid)) ex.hallBanquets.push(bid); save(); }
function removeHallBanquet(hid,bid){ pushHistory(); const ex=getHallExtra(hid); ex.hallBanquets = ex.hallBanquets.filter(x=>x!==bid); save(); }
function setSharedWaiter(hid,wid){ pushHistory(); const ex=getHallExtra(hid); ex.sharedWaiter = wid || null; save(); }

/* ====== —à–∞–±–ª–æ–Ω—ã ====== */
const chipTpl=document.getElementById('chipTpl');
const hallTpl=document.getElementById('hallTpl');
const posCardTpl=document.getElementById('posCardTpl');

let selected=null; // {k:'w'|'b', id}

/* ====== —Å—á—ë—Ç—á–∏–∫ ====== */
function renderShiftBadge(){
  const n = uniqueWaitersAll().size;
  db.shiftSize[dateKey()] = n; save();
  $('#shiftBadge').textContent = `üë• –í —Å–º–µ–Ω–µ: ${n}`;
}

/* ====== –æ—Ñ–∏—Ü–∏–∞–Ω—Ç—ã ====== */
function renderWaiterChip(w, isSecondary=false){
  const chip=chipTpl.content.firstElementChild.cloneNode(true);
  chip.querySelector('.name').textContent=w.name;
  chip.querySelector('.note').textContent=getNotes(w.id).join(', ');
  const {bg,fg}=colorForWaiter(w.id);
  chip.style.background=bg; chip.style.color=fg; chip.style.borderColor=bg;

  if(selected && selected.k==='w' && selected.id===w.id) chip.classList.add('active');

  chip.addEventListener('click',e=>{
    if(e.target.closest('.edit')||e.target.closest('.del')) return;
    selected=(selected && selected.k==='w' && selected.id===w.id)?null:{k:'w',id:w.id};
    renderBanquetBar(); renderWaiters();
  },{passive:true});

  chip.querySelector('.edit').addEventListener('click',e=>{
    e.stopPropagation(); openCommentsModal(w.id, w.name);
  });

  chip.querySelector('.del').addEventListener('click',e=>{
    e.stopPropagation();
    if(!confirm(`–£–¥–∞–ª–∏—Ç—å ¬´${w.name}¬ª?`)) return;
    pushHistory();
    for(const day in db.assignments){
      const halls=db.assignments[day];
      for(const hid in halls){ for(const pid in halls[hid]){ halls[hid][pid]=(halls[hid][pid]||[]).filter(x=>!(x.k==='w'&&x.id===w.id)); } }
    }
    for(const day in db.notes){ if(db.notes[day]) delete db.notes[day][w.id]; }
    db.waiters=db.waiters.filter(x=>x.id!==w.id);
    db.metaShifts.primary=db.metaShifts.primary.filter(n=>n!==w.name);
    db.metaShifts.secondary=db.metaShifts.secondary.filter(n=>n!==w.name);
    for(const day in db.hallExtras){
      const m=db.hallExtras[day]||{};
      for(const hid in m){ if(m[hid] && m[hid].sharedWaiter===w.id) m[hid].sharedWaiter=null; }
    }
    if(selected && selected.k==='w' && selected.id===w.id) selected=null;
    save(); renderAll();
  });

  chip.dataset.secondary = isSecondary ? '1' : '0';
  return chip;
}
function renderWaiters(){
  const rowP=$('#rowPrimary'), rowS=$('#rowSecondary');
  rowP.innerHTML=''; rowS.innerHTML='';

  db.waiters.forEach(w=>{
    if(!db.metaShifts.primary.includes(w.name) && !db.metaShifts.secondary.includes(w.name)){
      db.metaShifts.primary.push(w.name);
    }
  });

  const map=Object.fromEntries(db.waiters.map(w=>[w.name,w]));
  db.metaShifts.primary.forEach(n=>{ const w=map[n]; if(w) rowP.appendChild(renderWaiterChip(w,false)); });
  db.metaShifts.secondary.forEach(n=>{ const w=map[n]; if(w) rowS.appendChild(renderWaiterChip(w,true)); });

  save();
}

/* ====== –±–∞–Ω–∫–µ—Ç—ã (–≤–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å) ====== */
function renderBanquetBar(){
  const bar=$('#banquetBar'); bar.innerHTML='';
  const addBtn=document.createElement('button'); addBtn.className='b-chip'; addBtn.textContent='+ –ë–∞–Ω–∫–µ—Ç';
  addBtn.onclick=()=>openBanquetModal(); bar.appendChild(addBtn);

  banquetsForDay().forEach(b=>{
    const meta=BANQUET_TYPES[b.type]||BANQUET_TYPES['–î—Ä—É–≥–æ–π'];
    const chip=document.createElement('div'); chip.className='b-chip';
    if(selected&&selected.k==='b'&&selected.id===b.id) chip.classList.add('active');
    const title=(b.type==='–î—Ä—É–≥–æ–π'&&b.other)?`–î—Ä—É–≥–æ–µ: ${b.other}`:meta;
    chip.textContent=`${title} ¬∑ ${b.people}`;
    const actions=document.createElement('span'); actions.className='b-actions';
    const edit=document.createElement('button'); edit.className='icon-btn'; edit.textContent='‚úèÔ∏è';
    const del=document.createElement('button'); del.className='icon-btn'; del.textContent='üóë';
    edit.onclick=(e)=>{e.stopPropagation(); openBanquetModal(b);};
    del.onclick=(e)=>{e.stopPropagation(); deleteBanquet(b.id);};
    chip.appendChild(actions); actions.appendChild(edit); actions.appendChild(del);
    chip.addEventListener('click',()=>{ selected=(selected&&selected.k==='b'&&selected.id===b.id)?null:{k:'b',id:b.id}; renderBanquetBar(); },{passive:true});
    bar.appendChild(chip);
  });
}
function deleteBanquet(id){
  pushHistory();
  const arr=banquetsForDay(); const i=arr.findIndex(x=>x.id===id); if(i>-1) arr.splice(i,1);
  const ass=dayAss(); for(const hid in ass){ for(const pid in ass[hid]){ ass[hid][pid]=(ass[hid][pid]||[]).filter(x=>!(x.k==='b'&&x.id===id)); } }
  const extras=hallExtrasForDay(); for(const hid in extras){ if(extras[hid]) extras[hid].hallBanquets = (extras[hid].hallBanquets||[]).filter(bid=>bid!==id); }
  if(selected && selected.k==='b' && selected.id===id) selected=null;
  save(); renderAll(); /* –≤–∞–∂–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ: –æ–±–Ω–æ–≤–ª—è–µ–º –∏ –≤–µ—Ä—Ö–Ω–∏–µ —á–∏–ø—ã */
}

/* ====== –∫–æ–ª–æ–Ω–∫–∏ ====== */
const hallBriefEls=new Map(), hallTotalEls=new Map();
function renderColumns(){
  const c1=$('#col1'), c2=$('#col2'), c3=$('#col3');
  c1.innerHTML=''; c2.innerHTML=''; c3.innerHTML='';
  hallBriefEls.clear(); hallTotalEls.clear();
  const map=hallsByName();
  try{ mountHall(map['–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'], c1); }catch(e){ console.error('–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª:',e); }
  try{ mountHall(map['–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª'], c1); }catch(e){ console.error('–ú–ë–ó:',e); }
  try{ mountHall(map['–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã'], c2); }catch(e){ console.error('–í–ò–ü:',e); }
  try{ mountHall(map['–õ–æ—Ñ—Ç'], c2); }catch(e){ console.error('–õ–æ—Ñ—Ç:',e); }
  try{ mountHall(map['–í–µ—Ä–∞–Ω–¥–∞'], c3); }catch(e){ console.error('–í–µ—Ä–∞–Ω–¥–∞:',e); }
  try{ mountHall(map['–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞'], c3); }catch(e){ console.error('–í–∏–Ω–Ω–∞—è:',e); }
  updateAllHallTotals(); renderShiftBadge();
}
function mountHall(h,into){
  if(!h || !into) return;
  const sec=hallTpl.content.firstElementChild.cloneNode(true);
  sec.dataset.hid=h.id;
  sec.querySelector('.hall-title').textContent=(HALL_ICONS[h.name]||'')+' '+h.name;
  const totalEl=sec.querySelector('.hall-total'); hallTotalEls.set(h.id,totalEl);
  const briefEl=sec.querySelector('.hall-brief'); hallBriefEls.set(h.id, briefEl);
  const grid=sec.querySelector('.pos-grid');

  const tools=document.createElement('div'); tools.className='hall-tools';

  if(h.name==='–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'){
    const addHallB=document.createElement('button');
    addHallB.className='btn mini';
    addHallB.textContent='üèõÔ∏èüéâ + –ë–∞–Ω–∫–µ—Ç –¥–ª—è –≤—Å–µ–≥–æ –∑–∞–ª–∞';
    addHallB.onclick=()=>openBanquetModal(null, {hallWide:h.id});
    tools.appendChild(addHallB);

    const ex=getHallExtra(h.id);
    (ex.hallBanquets||[]).forEach(bid=>{
      const b=banquetById(bid); if(!b) return;
      const pill=document.createElement('span'); pill.className='hall-pill';
      const title=(b.type==='–î—Ä—É–≥–æ–π'&&b.other)?`–î—Ä—É–≥–æ–µ: ${b.other}`:(BANQUET_TYPES[b.type]||'–ë–∞–Ω–∫–µ—Ç');
      pill.innerHTML=`<span class="tag">–í–ï–°–¨ –ó–ê–õ</span> ${title} ¬∑ ${b.people}`;
      const x=document.createElement('button'); x.className='x'; x.textContent='√ó';
      x.onclick=()=>{ removeHallBanquet(h.id,bid); renderAll(); /* –≤–∞–∂–Ω–æ: —á—Ç–æ–±—ã —á–∏–ø –≤–≤–µ—Ä—Ö—É —Ç–æ–∂–µ –æ–±–Ω–æ–≤–∏–ª—Å—è */ };
      pill.appendChild(x);
      tools.appendChild(pill);
    });
  }

  if(h.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã'){
    const ex=getHallExtra(h.id);
    const wrap=document.createElement('div'); wrap.className='hall-pill';
    const sel=document.createElement('select');
    sel.innerHTML='<option value="">‚Äî –æ–±—â–∏–π –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –í–ò–ü ‚Äî</option>';
    db.waiters.forEach(w=>{ const o=document.createElement('option'); o.value=w.id; o.textContent=w.name; sel.appendChild(o); });
    const btnSet=document.createElement('button'); btnSet.className='btn mini'; btnSet.textContent='–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
    btnSet.onclick=()=>{ if(sel.value){ setSharedWaiter(h.id, sel.value); renderColumns(); renderShiftBadge(); } };
    const btnClr=document.createElement('button'); btnClr.className='btn mini'; btnClr.textContent='–£–±—Ä–∞—Ç—å';
    btnClr.onclick=()=>{ setSharedWaiter(h.id, null); renderColumns(); renderShiftBadge(); };

    wrap.prepend(document.createTextNode('üëëüë§ '));
    wrap.appendChild(sel); wrap.appendChild(btnSet); wrap.appendChild(btnClr);
    if(ex.sharedWaiter){
      const w=waiterById(ex.sharedWaiter);
      const tag=document.createElement('span'); tag.className='tag'; tag.textContent = w? `–û–±—â–∏–π: ${w.name}` : '–û–±—â–∏–π: ‚Äî';
      wrap.appendChild(tag);
    }
    tools.appendChild(wrap);
  }

  if(tools.childNodes.length) sec.insertBefore(tools, grid);

  h.positions.forEach(p=>{
    const card=posCardTpl.content.firstElementChild.cloneNode(true);
    card.querySelector('.pos-title').textContent=(POS_ICONS[p.name]||'')+' '+p.name;
    const counter=card.querySelector('.counter');
    const slot=card.querySelector('.slot');
    const pick=card.querySelector('.pick');
    const addBtn=card.querySelector('.addBtn');
    fillPick(pick);

    const draw=()=>{
      const arr=ensureSlot(h.id,p.id);
      slot.innerHTML='';

      if(h.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã'){
        const sw=getHallExtra(h.id).sharedWaiter;
        if(sw){
          const w=waiterById(sw); if(w){
            const {bg,fg}=colorForWaiter(sw);
            const el=renderAssign(w.name, getNotes(sw), bg, fg, null);
            el.querySelector('.x')?.remove();
            slot.appendChild(el);
          }
        }
      }

      arr.forEach(ent=>{
        if(ent.k==='w'){
          const w=waiterById(ent.id); if(!w) return;
          const {bg,fg}=colorForWaiter(ent.id);
          const el=renderAssign(w.name, getNotes(ent.id), bg, fg, ()=>{ removeEnt(h.id,p.id,ent); draw(); });
          slot.appendChild(el);
        }else{
          const b=banquetById(ent.id); if(!b) return;
          const title=(b.type==='–î—Ä—É–≥–æ–π'&&b.other)?`–î—Ä—É–≥–æ–µ: ${b.other}`:(BANQUET_TYPES[b.type]||'–ë–∞–Ω–∫–µ—Ç'); /* FIX */
          const label=`${title} ¬∑ ${b.people}`;
          const el=renderAssign(label, b.note? [b.note] : [], '#fff', '#0f172a', ()=>{ removeEnt(h.id,p.id,ent); draw(); });
          slot.appendChild(el);
        }
      });

      const ids=new Set(arr.filter(e=>e.k==='w').map(e=>e.id));
      if(h.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã' && getHallExtra(h.id).sharedWaiter) ids.add(getHallExtra(h.id).sharedWaiter);
      counter.textContent=String(ids.size);

      refreshHallBrief(h.id); renderShiftBadge();
    };

    function assign(hid,pid,ent){
      pushHistory();
      const arr=ensureSlot(hid,pid);
      if(arr.some(x=>x.k===ent.k && x.id===ent.id)) return;
      if(ent.k==='w'){
        const w=waiterById(ent.id);
        if(db.metaShifts.secondary.includes(w.name)){
          const tags=getNotes(ent.id); if(!tags.includes('–£—Å–∏–ª–µ–Ω–∏–µ')) addNote(ent.id,'–£—Å–∏–ª–µ–Ω–∏–µ');
        }
      }
      arr.push(ent); save(); draw();
    }
    function removeEnt(hid,pid,ent){
      pushHistory();
      const arr=ensureSlot(hid,pid); const i=arr.findIndex(x=>x.k===ent.k && x.id===ent.id);
      if(i>-1) arr.splice(i,1); save();
    }

    card.addEventListener('click',e=>{
      if(e.target.closest('.adder')||e.target.closest('.assign')) return;
      if(!selected) return;
      assign(h.id,p.id, selected);
    });
    addBtn.addEventListener('click',e=>{
      e.stopPropagation();
      const wid=pick.value; if(!wid) return;
      assign(h.id,p.id,{k:'w',id:wid}); pick.value='';
    });

    draw();
    grid.appendChild(card);
  });

  into.appendChild(sec);
}
function refreshHallBrief(hid){
  const briefEl=hallBriefEls.get(hid); if(!briefEl) return;
  const hall=db.halls.find(x=>x.id===hid); if(!hall){ briefEl.textContent=''; briefEl.classList.remove('has'); return; }
  const ass=dayAss();
  const parts=[], countsByPos=[];
  const ex=getHallExtra(hid);

  if(ex.hallBanquets && ex.hallBanquets.length){
    const list = ex.hallBanquets.map(bid=>{
      const b=banquetById(bid); if(!b) return null;
      const title=(b.type==='–î—Ä—É–≥–æ–π'&&b.other)?('–î—Ä—É–≥–æ–µ: '+b.other):(BANQUET_TYPES[b.type]||'–ë–∞–Ω–∫–µ—Ç');
      return `${title} ¬∑ ${b.people}`+(b.note?` (${b.note})`:'');
    }).filter(Boolean);
    if(list.length) parts.push(`–ë–∞–Ω–∫–µ—Ç (–≤–µ—Å—å –∑–∞–ª): ${list.join(' | ')}`);
  }

  if(ex.sharedWaiter){
    const w=waiterById(ex.sharedWaiter);
    if(w && hall.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã') parts.push(`–û–±—â–∏–π: ${w.name}`);
  }

  (hall.positions||[]).forEach(p=>{
    const arr=(ass[hid]&&ass[hid][p.id])||[];
    if(!arr.length) return;
    const people = arr.map(e=>{
      if(e.k==='w'){
        const w=waiterById(e.id); if(!w) return '‚Äî';
        const cm=getNotes(e.id); return w.name + (cm.length? ` (${cm.join(', ')})` : '');
      }else{
        const b=banquetById(e.id); if(!b) return '–ë–∞–Ω–∫–µ—Ç';
        const title=(b.type==='–î—Ä—É–≥–æ–π'&&b.other)?('–î—Ä—É–≥–æ–µ: '+b.other):(BANQUET_TYPES[b.type]||'–ë–∞–Ω–∫–µ—Ç');
        return `${title} ¬∑ ${b.people}`+(b.note?` (${b.note})`:'');
      }
    });
    parts.push(`${p.name}: ${people.join(', ')}`);
    const uniq = new Set(arr.filter(e=>e.k==='w').map(e=>e.id));
    if(hall.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã' && getHallExtra(hid).sharedWaiter) uniq.add(getHallExtra(hid).sharedWaiter);
    countsByPos.push(`${uniq.size} –Ω–∞ ${p.name}`);
  });

  const has=parts.length>0;
  briefEl.textContent = has ? parts.join(' ‚Ä¢ ') : '';
  briefEl.classList.toggle('has', has);

  const totalEl=hallTotalEls.get(hid);
  if(totalEl){
    const all = [];
    (hall.positions||[]).forEach(p=>{
      const arr=(ass[hid]&&ass[hid][p.id])||[];
      arr.filter(e=>e.k==='w').forEach(e=>all.push(e.id));
    });
    if(hall.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã' && getHallExtra(hid).sharedWaiter) all.push(getHallExtra(hid).sharedWaiter);
    const uniq = new Set(all);
    totalEl.textContent = uniq.size ? (countsByPos.join(', ') + ` ‚Äî –í—Å–µ–≥–æ: ${uniq.size}`) : '';
  }
}
function updateAllHallTotals(){ db.halls.forEach(h=> refreshHallBrief(h.id)); }

/* ====== —ç–ª–µ–º–µ–Ω—Ç –≤ –ø–æ–∑–∏—Ü–∏–∏ ====== */
function renderAssign(name, notesArr, bg, fg, onRemove){
  const el=document.createElement('div'); el.className='assign';
  if(bg){ el.style.background=bg; el.style.borderColor=bg; }
  if(fg){ el.style.color=fg; }
  const top=document.createElement('div'); top.className='top';
  const nm=document.createElement('div'); nm.className='w-name'; nm.textContent=name;
  const x=document.createElement('button'); x.className='x'; x.title='–£–±—Ä–∞—Ç—å'; x.textContent='√ó';
  if(onRemove){ x.onclick=(e)=>{ e.stopPropagation(); onRemove(); }; } else { x.remove(); }
  top.appendChild(nm); top.appendChild(x);
  const note=document.createElement('div'); note.className='w-note';
  note.textContent = (notesArr && notesArr.length) ? notesArr.join(', ') : '';
  el.appendChild(top); el.appendChild(note);
  return el;
}

/* ====== –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ====== */
function openCommentsModal(wid, wname){
  const presets=['–ü–æ–º–æ—â—å –Ω–∞ –≤–µ—Ä–∞–Ω–¥–µ 1','–ü–æ–º–æ—â—å –Ω–∞ –≤–µ—Ä–∞–Ω–¥–µ 2','–ü–æ–º–æ—â—å –≤ –û–ó','–ü–æ–º–æ—â—å –Ω–∞ –í–ò–ü–∞—Ö','–ü–æ–º–æ—â—å –≤ –ú–ë–ó','–ü–µ—Ä–≤—ã–π –Ω–æ–º–µ—Ä –Ω–∞ –±–∞–Ω–∫–µ—Ç–µ','–í—Ç–æ—Ä–æ–π –Ω–æ–º–µ—Ä –Ω–∞ –±–∞–Ω–∫–µ—Ç–µ','–£—Å–∏–ª–µ–Ω–∏–µ'];
  const wrap=document.createElement('div'); wrap.className='modal';
  wrap.innerHTML = '<div class="dialog">'+
    '<div style="font-weight:900">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ‚Äî '+wname+'</div>'+
    '<div id="presetBox" style="display:flex;flex-wrap:wrap;gap:6px"></div>'+
    '<div id="tagList" style="display:flex;flex-wrap:wrap;gap:6px"></div>'+
    '<div class="row"><label>–ù–æ–≤—ã–π</label><input id="cInp" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –¥–æ 18:00"/></div>'+
    '<div class="row" style="justify-content:flex-end"><button id="cAdd" class="btn btn-acc">–î–æ–±–∞–≤–∏—Ç—å</button><button id="cClose">–ó–∞–∫—Ä—ã—Ç—å</button></div>'+
  '</div>';
  document.body.appendChild(wrap);

  const box=wrap.querySelector('#presetBox'), list=wrap.querySelector('#tagList'), inp=wrap.querySelector('#cInp');
  function redraw(){
    list.innerHTML='';
    getNotes(wid).forEach((t,i)=>{
      const tag=document.createElement('span');
      tag.style.cssText='font-size:11px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;display:inline-flex;align-items:center;gap:6px';
      const x=document.createElement('b'); x.textContent='√ó'; x.style.cssText='cursor:pointer;color:#991b1b';
      x.onclick=()=>{ delNote(wid,i); redraw(); renderAll(); };
      tag.appendChild(document.createTextNode(t)); tag.appendChild(x); list.appendChild(tag);
    });
  }
  presets.forEach(p=>{
    const b=document.createElement('button'); b.textContent=p; b.className='btn';
    b.style.cssText='border:1px dashed #cbd5e1;border-radius:999px;padding:4px 8px;background:#fff;font-size:11px';
    b.onclick=()=>{ const cur=getNotes(wid); const i=cur.indexOf(p); if(i===-1) addNote(wid,p); else delNote(wid,i); redraw(); renderAll(); };
    box.appendChild(b);
  });
  wrap.querySelector('#cAdd').onclick=()=>{ const v=(inp.value||'').trim(); if(!v) return; addNote(wid,v); inp.value=''; redraw(); renderAll(); };
  wrap.querySelector('#cClose').onclick=()=>wrap.remove();
  wrap.addEventListener('click',e=>{ if(e.target===wrap) wrap.remove(); });
  redraw();
}

/* ====== –±–∞–Ω–∫–µ—Ç: –º–æ–¥–∞–ª–∫–∞ —Å –≤—ã–±–æ—Ä–æ–º –º–µ—Å—Ç–∞ –∏ hall-wide ====== */
function openBanquetModal(existing, opts){
  const isEdit=!!existing;
  const hallWideId = opts && opts.hallWide ? String(opts.hallWide) : null;
  const wrap=document.createElement('div'); wrap.className='modal';

  const placeOptions = db.halls.map(h=>{
    const opts = h.positions.map(p=>`<option value="${h.id}|${p.id}">${h.name} ‚Äî ${p.name}</option>`).join('');
    return `<optgroup label="${h.name}">${opts}</optgroup>`;
  }).join('');

  wrap.innerHTML = '<div class="dialog">'+
    `<div style="font-weight:900">${isEdit?'–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–Ω–∫–µ—Ç':'–ù–æ–≤—ã–π –±–∞–Ω–∫–µ—Ç'}</div>`+
    '<div class="row"><label>–ö–æ–ª-–≤–æ –ø–µ—Ä—Å–æ–Ω</label><input id="bnPeople" type="number" min="1" inputmode="numeric" placeholder="25"/></div>'+
    '<div class="row"><label>–í–∏–¥</label><select id="bnType"><option>–î–†</option><option>–°–≤–∞–¥—å–±–∞</option><option>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤</option><option>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</option><option>–î–µ–Ω—å –ø–∞–º—è—Ç–∏</option><option>–î—Ä—É–≥–æ–π</option></select></div>'+
    '<div class="row" id="bnOtherRow" style="display:none"><label>–î—Ä—É–≥–æ–π</label><input id="bnOther"/></div>'+
    '<div class="row"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="bnNote" rows="3" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è, —Ç–∞–π–º–∏–Ω–≥..."></textarea></div>'+
    `<div class="row"><label>–ú–µ—Å—Ç–æ</label><select id="bnPlace"><option value="">‚Äî –Ω–µ –≤—ã–±–∏—Ä–∞—Ç—å ‚Äî</option>${placeOptions}</select></div>`+
    (hallWideId? '<div class="weak" style="margin-top:-4px">–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ: <b>–≤–µ—Å—å –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª</b></div>' : '')+
    `<div class="row" style="justify-content:flex-end"><button id="bnSave" class="btn btn-acc">${isEdit?'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å'}</button><button id="bnClose">–ó–∞–∫—Ä—ã—Ç—å</button></div>`+
  '</div>';

  document.body.appendChild(wrap);
  const people=wrap.querySelector('#bnPeople'), type=wrap.querySelector('#bnType'),
        otherRow=wrap.querySelector('#bnOtherRow'), other=wrap.querySelector('#bnOther'),
        note=wrap.querySelector('#bnNote'), place=wrap.querySelector('#bnPlace');

  type.onchange=()=>{ otherRow.style.display=(type.value==='–î—Ä—É–≥–æ–π')?'flex':'none'; };
  if(isEdit){
    people.value=existing.people; type.value=existing.type; note.value=existing.note||'';
    if(existing.type==='–î—Ä—É–≥–æ–π'){ otherRow.style.display='flex'; if(other) other.value=existing.other||''; }
  }

  wrap.querySelector('#bnSave').onclick=()=>{
    const n=parseInt(people.value,10); if(!(n>0)) return alert('–£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ –ø–µ—Ä—Å–æ–Ω.');
    pushHistory();
    let b;
    if(isEdit){
      existing.people=n; existing.type=type.value; existing.other=(other&&other.value||'').trim(); existing.note=(note.value||'').trim();
      b=existing;
    } else {
      b={id:UUID(), people:n, type:type.value, other:(other&&other.value||'').trim(), note:(note.value||'').trim()};
      banquetsForDay().push(b);
    }

    if(hallWideId){ addHallBanquet(hallWideId, b.id); }

    if(place.value){
      const [hid,pid]=String(place.value).split('|');
      const arr=ensureSlot(hid,pid);
      if(!arr.some(x=>x.k==='b'&&x.id===b.id)){ arr.push({k:'b',id:b.id}); }
    }

    save();
    try { renderAll(); } catch(e){ console.error('renderAll error:',e); renderColumns(); }
    wrap.remove();
  };
  wrap.querySelector('#bnClose').onclick=()=>wrap.remove();
  wrap.addEventListener('click',e=>{ if(e.target===wrap) wrap.remove(); });
}

/* ====== —Å–ª—É–∂–µ–±–Ω—ã–µ ====== */
function fillPick(selectEl){
  selectEl.innerHTML='<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞ ‚Äî</option>';
  db.waiters.forEach(w=>{ const opt=document.createElement('option'); opt.value=w.id; opt.textContent=w.name; selectEl.appendChild(opt); });
}
function renderShiftAndTotals(){ updateAllHallTotals(); renderShiftBadge(); }

/* ====== —ç–∫—Å–ø–æ—Ä—Ç –æ—Ç—á—ë—Ç–∞ ====== */
function exportTextWhatsApp(){
  const iso = dateKey();
  const n = uniqueWaitersAll().size;
  const lines = [
    '–î–æ–±—Ä—ã–π –¥–µ–Ω—å, –¥—Ä—É–∑—å—è!',
    `üìÖ ${fmtDateRU(iso)}`,
    `–í —Å–º–µ–Ω–µ ${n} —á–µ–ª–æ–≤–µ–∫. üï∫`,
    ''
  ];
  const b = banquetsForDay();
  if(b.length===0){
    lines.push('–ë–∞–Ω–∫–µ—Ç—ã: 0', '');
  }else{
    const list = b.map(x=>{
      const title = (x.type==='–î—Ä—É–≥–æ–π'&&x.other)?('–î—Ä—É–≥–æ–µ: '+x.other):(BANQUET_TYPES[x.type]||'–ë–∞–Ω–∫–µ—Ç');
      return `${title} ¬∑ ${x.people}` + (x.note?` (${x.note})`:'');
    }).join(' | ');
    lines.push('–ë–∞–Ω–∫–µ—Ç—ã: '+list, '');
  }

  const ass=dayAss();
  db.halls.forEach(h=>{
    const ex=getHallExtra(h.id);
    const hasHallWide = ex.hallBanquets && ex.hallBanquets.length>0;
    const hasShared = !!ex.sharedWaiter && h.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã';
    const hasAnyPos = (h.positions||[]).some(p=> (ass[h.id]&&ass[h.id][p.id]||[]).length>0 );
    if(!hasHallWide && !hasShared && !hasAnyPos) return;

    lines.push(`${(HALL_ICONS[h.name]||'')} *${h.name}*:`);

    if(hasHallWide && h.name==='–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª'){
      const text = ex.hallBanquets.map(bid=>{
        const x=banquetById(bid); if(!x) return null;
        const title=(x.type==='–î—Ä—É–≥–æ–π'&&x.other)?('–î—Ä—É–≥–æ–µ: '+x.other):(BANQUET_TYPES[x.type]||'–ë–∞–Ω–∫–µ—Ç');
        return `${title} ¬∑ ${x.people}` + (x.note?` (${x.note})`:'');
      }).filter(Boolean).join(' | ');
      if(text) lines.push(`‚Ä¢ –ë–∞–Ω–∫–µ—Ç (–≤–µ—Å—å –∑–∞–ª): ${text}`);
    }

    if(hasShared){
      const w=waiterById(ex.sharedWaiter);
      if(w) lines.push(`‚Ä¢ –û–±—â–∏–π –æ—Ñ–∏—Ü–∏–∞–Ω—Ç: ${w.name}`);
    }

    h.positions.forEach(p=>{
      const arr=(ass[h.id]&&ass[h.id][p.id])||[];
      if(!arr.length && !(hasShared && h.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã')) return;
      const list=[];
      if(hasShared && h.name==='–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã'){
        const w=waiterById(ex.sharedWaiter);
        if(w){
          const cm=getNotes(w.id);
          list.push(cm.length? `${w.name} _(${cm.join(', ')})_` : w.name);
        }
      }
      arr.forEach(e=>{
        if(e.k==='w'){
          const w=waiterById(e.id); const cm=getNotes(e.id);
          list.push(w ? (cm.length? `${w.name} _(${cm.join(', ')})_` : w.name) : '‚Äî');
        }else{
          const x=banquetById(e.id); if(!x) return;
          const title=(x.type==='–î—Ä—É–≥–æ–π'&&x.other)?('–î—Ä—É–≥–æ–µ: '+x.other):(BANQUET_TYPES[x.type]||'–ë–∞–Ω–∫–µ—Ç');
          list.push(x.note ? `${title} ¬∑ ${x.people} _(${x.note})_` : `${title} ¬∑ ${x.people}`);
        }
      });
      if(list.length) lines.push(`‚Ä¢ ${(POS_ICONS[p.name]||'')} ${p.name}: ${list.join(' | ')}`);
    });
    lines.push('');
  });

  lines.push('–í—Å–µ–º —Ö–æ—Ä–æ—à–µ–π —Å–º–µ–Ω—ã –∏ –±–æ–ª—å—à–∏—Ö —á–∞–µ–≤—ã—Ö! üíµ');
  return lines.join('\n');
}
function exportTextTelegram(){ return exportTextWhatsApp(); }
function exportTextEmail(){ return exportTextWhatsApp(); }

/* ====== –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç –±–∞–∑—ã ====== */
function exportDB(){
  const dataStr = JSON.stringify(db, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a');
  const stamp = new Date().toISOString().slice(0,10).replace(/-/g,'');
  a.href=url; a.download=`rota-backup-${stamp}.json`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}
function importDB(file){
  const reader=new FileReader();
  reader.onload = ()=>{
    try{
      const obj=JSON.parse(reader.result);
      if(!obj || !obj.halls || !obj.waiters || !obj.assignments) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞');
      pushHistory();
      db = obj;
      purgeOldData(); save(); renderAll(); renderShiftAndTotals();
      alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
    }catch(e){
      alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+e.message);
    }
  };
  reader.readAsText(file);
}

/* ====== —Å–±—Ä–æ—Å –¥–Ω—è ====== */
function resetCurrentDate(){
  pushHistory();
  const k=dateKey();
  db.assignments[k]={};
  db.notes[k]={};
  db.banquets[k]=[];
  delete db.shiftSize[k];
  if(db.hallExtras[k]) delete db.hallExtras[k];
  save();
}

/* ====== —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ====== */
function openStatsModal(){
  const end = new Date(dateKey()+'T00:00');
  const start = new Date(end); start.setDate(end.getDate()-29);
  const within=(iso)=>{ const d=new Date(iso+'T00:00'); return d>=start && d<=end; };

  const counts = {};
  Object.keys(db.assignments).filter(within).forEach(iso=>{
    const halls=db.assignments[iso]||{};
    for(const hid in halls){
      for(const pid in halls[hid]){
        (halls[hid][pid]||[]).forEach(e=>{
          if(e.k!=='w') return;
          counts[e.id] ||= {shifts:new Set(), byHall:{}};
          counts[e.id].shifts.add(iso);
          counts[e.id].byHall[hid] = (counts[e.id].byHall[hid]||0)+1;
        });
      }
    }
  });

  const wrap=document.createElement('div'); wrap.className='modal';
  const rows = Object.keys(counts).map(wid=>{
    const w=waiterById(wid); const hBy=counts[wid].byHall;
    const total=counts[wid].shifts.size;
    const top = Object.entries(hBy)
      .map(([hid,c])=>({name:db.halls.find(h=>h.id===hid)?.name||'?', c}))
      .sort((a,b)=>b.c-a.c).slice(0,3)
      .map(x=>x.name.replace(/ \(.*?\)/,'')).join(', ');
    return `<tr><td>${w?.name||'?'}</td><td style="text-align:center">${total}</td><td>${top||'‚Äî'}</td></tr>`;
  }).sort((a,b)=> a.localeCompare(b)).join('');

  wrap.innerHTML='<div class="dialog">'+
    '<div style="font-weight:900">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ 30 –¥–Ω–µ–π</div>'+
    `<div style="font-size:11px;color:#475569;margin-top:-4px">–ü–µ—Ä–∏–æ–¥: ${start.toLocaleDateString('ru-RU')} ‚Äî ${end.toLocaleDateString('ru-RU')}</div>`+
    '<div style="max-height:60vh;overflow:auto;margin-top:6px">'+
      '<table style="width:100%;border-collapse:collapse;font-size:12px">'+
        '<thead><tr><th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px 2px">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</th><th style="text-align:center;border-bottom:1px solid #e5e7eb;padding:6px 2px">–°–º–µ–Ω</th><th style="text-align:left;border-bottom:1px solid #e5e7eb;padding:6px 2px">–ß–∞—â–µ –≤ –∑–∞–ª–∞—Ö</th></tr></thead>'+
        `<tbody>${rows || '<tr><td colspan="3" style="padding:8px;color:#64748b">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –ø–µ—Ä–∏–æ–¥</td></tr>'}</tbody>`+
      '</table>'+
    '</div>'+
    '<div style="display:flex;justify-content:flex-end;gap:6px;margin-top:8px"><button id="stClose">–ó–∞–∫—Ä—ã—Ç—å</button></div>'+
  '</div>';
  document.body.appendChild(wrap);
  wrap.querySelector('#stClose').onclick=()=>wrap.remove();
  wrap.addEventListener('click',e=>{ if(e.target===wrap) wrap.remove(); });
}

/* ====== —Ä–µ–Ω–¥–µ—Ä –≤—Å–µ–≥–æ ====== */
function renderAll(){
  renderBanquetBar();
  renderWaiters();
  renderColumns();
}

/* ====== PWA ====== */
let deferredPrompt=null;
function registerSW(){
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
}
window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt=e;
  const b=$('#installBtn'); if(b) b.style.display='inline-block';
});
function installApp(){
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.finally(()=>{ deferredPrompt=null; $('#installBtn').style.display='none'; });
}

/* ====== init ====== */
document.addEventListener('DOMContentLoaded', function(){
  showOK(); registerSW();

  const dateEl=document.getElementById('date');
  dateEl.value = dateEl.value || todayISO();
  renderAll();
  renderShiftAndTotals();
  updateUndoRedoButtons();

  dateEl.addEventListener('change', ()=>{ renderAll(); renderShiftAndTotals(); });

  document.getElementById('toggleSecondary').addEventListener('click',()=>{
    const rowS=$('#rowSecondary'); const open=rowS.style.display==='none';
    rowS.style.display=open?'grid':'none';
    document.getElementById('toggleSecondary').textContent=open?'2-—è —Å–º–µ–Ω–∞ ‚Üë':'2-—è —Å–º–µ–Ω–∞ ‚Üì';
  });

  document.getElementById('addWaiter').addEventListener('click',()=>{
    const wrap=document.createElement('div'); wrap.className='modal';
    wrap.innerHTML='<div class="dialog">'+
      '<div style="font-weight:900">–ù–æ–≤—ã–π –æ—Ñ–∏—Ü–∏–∞–Ω—Ç</div>'+
      '<div class="row"><label>–ò–º—è</label><input id="wName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–∞–≤–µ–ª"/></div>'+
      '<div class="row"><label>–°–º–µ–Ω–∞</label><select id="wShift"><option value="1">1-—è —Å–º–µ–Ω–∞</option><option value="2">2-—è —Å–º–µ–Ω–∞</option></select></div>'+
      '<div class="row" style="justify-content:flex-end"><button id="wSave" class="btn btn-acc">–î–æ–±–∞–≤–∏—Ç—å</button><button id="wClose">–û—Ç–º–µ–Ω–∞</button></div>'+
    '</div>';
    document.body.appendChild(wrap);
    const input=wrap.querySelector('#wName'), sel=wrap.querySelector('#wShift');
    wrap.querySelector('#wSave').onclick=()=>{
      const name=(input.value||'').trim(); if(!name) return;
      if(db.waiters.some(w=>w.name.toLowerCase()===name.toLowerCase())) return alert('–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.');
      pushHistory();
      const w={id:UUID(), name};
      db.waiters.push(w);
      if(sel.value==='2'){
        db.metaShifts.secondary.push(name);
        db.metaShifts.primary = db.metaShifts.primary.filter(n=>n!==name);
      }else{
        db.metaShifts.primary.push(name);
        db.metaShifts.secondary = db.metaShifts.secondary.filter(n=>n!==name);
      }
      save(); renderAll(); wrap.remove();
    };
    wrap.querySelector('#wClose').onclick=()=>wrap.remove();
    wrap.addEventListener('click',e=>{ if(e.target===wrap) wrap.remove(); });
    setTimeout(()=>input.focus(),0);
  });

  document.getElementById('undoBtn').addEventListener('click', undo);
  document.getElementById('redoBtn').addEventListener('click', redo);

  document.getElementById('exportBtn').addEventListener('click', exportDB);
  document.getElementById('importBtn').addEventListener('click', ()=> $('#importFile').click() );
  document.getElementById('importFile').addEventListener('change', (e)=>{
    const f=e.target.files && e.target.files[0];
    if(f) importDB(f);
    e.target.value='';
  });

  document.getElementById('copy').addEventListener('click', async ()=>{
    const txt=exportTextWhatsApp(); try{ await navigator.clipboard.writeText(txt); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }catch(e){ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:\n\n'+txt); }
  });
  document.getElementById('shareWA').addEventListener('click', ()=>{
    const text = exportTextWhatsApp();
    const urlWeb = 'https://wa.me/?text=' + encodeURIComponent(text);
    const urlApp = 'whatsapp://send?text=' + encodeURIComponent(text);
    const a = document.createElement('a'); a.href=urlApp; document.body.appendChild(a); a.click();
    setTimeout(()=>{ window.open(urlWeb, '_blank'); a.remove(); }, 300);
  });
  document.getElementById('shareTG').addEventListener('click', ()=>{
    const text = exportTextTelegram();
    const url = 'https://t.me/share/url?text=' + encodeURIComponent(text);
    window.open(url, '_blank');
  });
  document.getElementById('shareMail').addEventListener('click', ()=>{
    const text = exportTextEmail();
    const subj = '–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Äî ' + fmtDateRU(dateKey());
    const url = 'mailto:?subject=' + encodeURIComponent(subj) + '&body=' + encodeURIComponent(text);
    window.location.href = url;
  });

  document.getElementById('resetDay').addEventListener('click',()=>{
    if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É?')) return;
    resetCurrentDate(); renderAll(); renderShiftAndTotals(); updateUndoRedoButtons();
  });

  document.getElementById('statsBtn').addEventListener('click', openStatsModal);

  document.getElementById('installBtn').addEventListener('click', installApp);
});
})();
</script>
</body>
</html>
