<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Äî –∫–æ–º–ø–∞–∫—Ç+ —Å –∏—Ç–æ–≥–∞–º–∏</title>
<style>
  :root{ --bg:#fff; --text:#0f172a; --muted:#64748b; --border:#e5e7eb; --panel:#f8fafc }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:12px/1.25 system-ui,-apple-system,Segoe UI,Roboto}

  .header{position:sticky;top:0;z-index:10;display:grid;grid-template-columns:1fr;gap:6px;padding:6px;border-bottom:1px solid var(--border);background:#fff}
  .left{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
  label{font-size:10px;color:var(--muted)}
  .field{display:flex;gap:2px;flex-direction:column}
  input[type="date"],button{border:1px solid var(--border);background:#fff;border-radius:8px;min-height:28px;padding:4px 8px;font-size:12px}
  button{cursor:pointer}
  .btn-acc{border-color:#c7d2fe}
  .btn-danger{border-color:#fecaca}

  .center{display:flex;align-items:center;gap:6px;flex-wrap:wrap;justify-content:center}
  .b-chip{border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:#fff;display:inline-flex;gap:6px;align-items:center;font-weight:700;font-size:12px;cursor:pointer}
  .b-chip.active{outline:2px solid rgba(99,102,241,.25)}
  .b-actions{display:inline-flex;gap:4px}
  .icon-btn{border:1px solid var(--border);background:#fff;border-radius:6px;padding:2px 5px;font-size:11px}

  .waiters{display:grid;grid-auto-flow:column;grid-template-rows:repeat(2,auto);gap:4px 6px;overflow-x:auto;padding:2px 0}
  .chip{border:1px solid #c7d2fe;border-radius:999px;padding:4px 8px;background:#eef2ff;color:#0b1e4a;display:inline-flex;gap:6px;align-items:center}
  .chip .name{font-weight:800;font-size:12px}
  .chip .note-dot{font-size:10px;color:#475569}
  .chip .edit{border:1px solid var(--border);border-radius:6px;padding:1px 5px;background:#fff;font-size:11px}
  .chip .del{border:none;background:none;color:#991b1b;font-weight:900;font-size:14px;line-height:1;padding:0 4px}
  .chip.active{outline:2px solid rgba(99,102,241,.25)}

  .columns{display:grid;gap:6px;padding:6px;grid-template-columns:repeat(3,1fr)}
  details.panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:6px}
  summary{list-style:none;display:flex;gap:6px;align-items:flex-start;cursor:pointer}
  summary::-webkit-details-marker{display:none}
  .hall-title{font-weight:900;font-size:12px}
  .hall-brief{margin-left:auto;color:var(--muted);font-size:10px;line-height:1.25;max-width:65%;display:none;white-space:normal}
  details[open] .hall-brief{display:none}
  details.panel:not([open]) .hall-brief.has{display:block}

  .pos-grid{display:grid;gap:6px;margin-top:6px}
  .pos-card{background:#fff;border:1px solid var(--border);border-radius:10px;padding:6px;display:flex;flex-direction:column;gap:6px}
  .pos-head{display:flex;gap:6px;align-items:center}
  .pos-title{font-weight:800;font-size:12px}
  .counter{margin-left:auto;color:#475569;font-size:11px}
  .slot{display:flex;flex-wrap:wrap;gap:4px;border:1px dashed #e2e8f0;border-radius:8px;padding:6px;min-height:32px}

  .assign{display:inline-flex;flex-direction:column;align-items:flex-start;gap:2px;border:1px solid var(--border);border-radius:8px;padding:4px 8px;background:#fafafa}
  .assign .top{display:flex;gap:6px;align-items:center}
  .assign .w-name{font-weight:800;font-size:12px}
  .assign .x{border:none;background:none;color:#991b1b;font-weight:900;font-size:14px;line-height:1;cursor:pointer;padding:0}
  .assign .w-note{font-size:10px;color:#64748b}

  .adder{display:flex;gap:6px;align-items:center}
  .adder select{border:1px solid var(--border);border-radius:8px;min-height:26px;padding:2px 6px;font-size:12px;max-width:100%}
  .adder .addBtn{border:1px solid #c7d2fe;background:#eef2ff;border-radius:8px;min-height:26px;padding:2px 8px;font-size:12px;cursor:pointer}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:flex;align-items:center;justify-content:center;padding:10px;z-index:50}
  .dialog{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;min-width:min(96vw,420px);display:flex;flex-direction:column;gap:8px}
  .row{display:flex;gap:6px;align-items:center}
  .row>label{min-width:120px;color:#64748b;font-size:12px}
  .row>input,.row>select,.row>textarea{flex:1;border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-size:12px}
  .row>textarea{min-height:70px}

  @media (max-width:430px){
    html,body{font-size:11px}
    input[type="date"],button{min-height:26px;font-size:11px}
    .chip .name,.assign .w-name{font-size:11px}
    .columns{gap:4px}
    .pos-card{padding:6px}
    .slot{padding:4px}
  }
</style>
</head>
<body>
  <div class="header">
    <div class="left">
      <div class="field">
        <label for="date">–î–∞—Ç–∞</label>
        <input id="date" type="date" />
      </div>
      <button id="addWaiter" class="btn-acc">–î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞</button>
      <button id="share" class="btn-acc">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      <button id="copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="resetDay" class="btn-danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button id="hardReset" title="–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
    </div>

    <div class="center" id="banquetBar" aria-label="–ë–∞–Ω–∫–µ—Ç—ã"></div>
    <div class="waiters" id="waiterRow" aria-label="–û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã"></div>
  </div>

  <div class="columns">
    <div class="col" id="col1"></div>
    <div class="col" id="col2"></div>
    <div class="col" id="col3"></div>
  </div>

  <!-- —à–∞–±–ª–æ–Ω—ã -->
  <template id="chipTpl">
    <div class="chip" tabindex="0">
      <span class="name"></span>
      <span class="note-dot"></span>
      <button class="edit" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">üí¨</button>
      <button class="del" title="–£–¥–∞–ª–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞">√ó</button>
    </div>
  </template>

  <template id="hallTpl">
    <details class="panel" open>
      <summary>
        <span class="hall-title"></span>
        <span class="hall-brief"></span>
      </summary>
      <div class="pos-grid"></div>
    </details>
  </template>

  <template id="posCardTpl">
    <div class="pos-card">
      <div class="pos-head">
        <div class="pos-title"></div>
        <div class="counter"></div>
      </div>
      <div class="adder">
        <select class="pick"><option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞ ‚Äî</option></select>
        <button class="addBtn">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div class="slot"></div>
    </div>
  </template>

<script>
'use strict';

/* ====== –ë–ê–ó–ê ====== */
const UUID=(crypto&&crypto.randomUUID)?()=>crypto.randomUUID():()=>('id-'+Math.random().toString(36).slice(2));
const STORAGE_KEY='rota-compact-v3'; // –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
const CHIP_COLORS=[['#E3F2FD','#0b1e4a'],['#FCE7F3','#3e1a36'],['#E8F5E9','#103b1f'],['#FFF3E0','#4a2f0b'],['#F3E8FF','#2e1065'],['#E0F2F1','#083d3b'],['#FFFDE7','#3a3000'],['#F1F5N9','#0f172a'],['#FFE4E6','#4a0b15'],['#EDE7F6','#1f1147']].map(([a,b])=>[a,b]);
const CANON_HALLS=[
  {name:'–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª', positions:['–ó–æ–Ω–∞ –æ–∫–Ω–∞','5-—è –ª–∏–Ω–∏—è','–°—Ç–æ–ª—ã 7, 8, 9','–°—Ç–æ–ª—ã 10, 11, 12','–ü–æ–¥–∏—É–º']},
  {name:'–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª', positions:['–ú–ë–ó']},
  {name:'–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã', positions:['–ë–æ–ª—å—à–æ–π –í–ò–ü','–ú–∞–ª—ã–π –í–ò–ü','–ö–∞—é—Ç–∞','–õ–∏–µ–Ω–¥–∞']},
  {name:'–í–µ—Ä–∞–Ω–¥–∞', positions:['–í–µ—Ä–∞–Ω–¥–∞ 1','–í–µ—Ä–∞–Ω–¥–∞ 2']},
  {name:'–õ–æ—Ñ—Ç', positions:['–õ–æ—Ñ—Ç']},
  {name:'–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞', positions:['–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞']}
];
const BANQUET_TYPES={'–î–†':'üéâ –î–†','–°–≤–∞–¥—å–±–∞':'üíç –°–≤–∞–¥—å–±–∞','–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤':'üè¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤','–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è':'üì£ –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è','–î–µ–Ω—å –ø–∞–º—è—Ç–∏':'üïØÔ∏è –î–µ–Ω—å –ø–∞–º—è—Ç–∏','–î—Ä—É–≥–æ–π':'üè∑Ô∏è –î—Ä—É–≥–æ–µ'};

function buildDB(){
  return {
    halls: CANON_HALLS.map(h=>({id:UUID(),name:h.name,positions:h.positions.map(n=>({id:UUID(),name:n}))})),
    waiters:['–ò–≥–æ—Ä—å','–í–∏–∫—Ç–æ—Ä','–†–æ–º–∞–Ω','–≠–ª–æ–Ω–∞','–ü–æ–ª–∏–Ω–∞','–ö—Å–µ–Ω–∏—è','–ù–∞—Ç–∞–ª—å—è –ß.','–ù–∞—Ç–∞–ª—å—è –í.','–ê–Ω–∞—Å—Ç–∞—Å–∏—è','–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞'].map(n=>({id:UUID(),name:n})),
    assignments:{},  // date -> hallId -> posId -> [{k:'w'|'b', id}]
    notes:{},        // date -> waiterId -> [tags]
    banquets:{}      // date -> [{id,type,people,other?,note?}]
  };
}
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY));}catch{return null;} }
let db = load() || buildDB();
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

/* ====== –£–¢–ò–õ–´ ====== */
const dateEl=document.getElementById('date');
function todayISO(){const tz=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-tz).toISOString().slice(0,10);}
function dateKey(){return dateEl.value || todayISO();}
function getHallsByName(){return Object.fromEntries(db.halls.map(h=>[h.name,h]));}
function getDayAss(){const k=dateKey(); if(!db.assignments[k]) db.assignments[k]={}; return db.assignments[k];}
function ensureSlot(hid,pid){const a=getDayAss(); if(!a[hid]) a[hid]={}; if(!Array.isArray(a[hid][pid])) a[hid][pid]=[]; return a[hid][pid];}
function notesForDay(){const k=dateKey(); if(!db.notes[k]) db.notes[k]={}; return db.notes[k];}
function getNotes(wid){const m=notesForDay(); return m[wid]||(m[wid]=[])}
function addNote(wid,t){const a=getNotes(wid); if(!a.includes(t)) a.push(t); save()}
function delNote(wid,i){const a=getNotes(wid); a.splice(i,1); save()}
function waiterById(id){return db.waiters.find(w=>w.id===id)}
function colorForWaiter(id){const i=Math.max(0, db.waiters.findIndex(w=>w.id===id)); const [bg,fg]=CHIP_COLORS[i%CHIP_COLORS.length]; return {bg,fg}}
function banquetsForDay(){const k=dateKey(); if(!db.banquets[k]) db.banquets[k]=[]; return db.banquets[k];}
function banquetById(id){return banquetsForDay().find(b=>b.id===id)}

/* ====== –®–ê–ü–ö–ê ====== */
const waiterRow=document.getElementById('waiterRow');
const chipTpl=document.getElementById('chipTpl');
const banquetBar=document.getElementById('banquetBar');
let selected=null; // {k:'w'|'b', id}

function fillAllPicks(){ document.querySelectorAll('.pick').forEach(fillPick); }
function fillPick(selectEl){
  selectEl.innerHTML='<option value="">‚Äî –≤—ã–±—Ä–∞—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞ ‚Äî</option>';
  db.waiters.forEach(w=>{ const opt=document.createElement('option'); opt.value=w.id; opt.textContent=w.name; selectEl.appendChild(opt); });
}

function renderWaiters(){
  waiterRow.innerHTML='';
  db.waiters.forEach(w=>{
    const chip=chipTpl.content.firstElementChild.cloneNode(true);
    chip.querySelector('.name').textContent=w.name;
    chip.querySelector('.note-dot').textContent=getNotes(w.id).length?'‚Ä¢':'';
    const {bg,fg}=colorForWaiter(w.id);
    chip.style.background=bg; chip.style.color=fg; chip.style.borderColor=bg;

    if(selected && selected.k==='w' && selected.id===w.id) chip.classList.add('active');
    chip.addEventListener('click',e=>{
      if(e.target.closest('.edit')||e.target.closest('.del')) return;
      selected=(selected && selected.k==='w' && selected.id===w.id)?null:{k:'w',id:w.id};
      renderWaiters(); renderBanquetBar();
    },{passive:true});

    chip.querySelector('.edit').addEventListener('click',e=>{
      e.stopPropagation(); openCommentsModal(w.id, w.name);
    });
    chip.querySelector('.del').addEventListener('click',e=>{
      e.stopPropagation();
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å ¬´${w.name}¬ª?`)) return;
      for(const day in db.assignments){
        const halls=db.assignments[day];
        for(const hid in halls){ for(const pid in halls[hid]){ halls[hid][pid]=(halls[hid][pid]||[]).filter(x=>!(x.k==='w'&&x.id===w.id)); } }
      }
      for(const day in db.notes){ if(db.notes[day]) delete db.notes[day][w.id]; }
      db.waiters=db.waiters.filter(x=>x.id!==w.id);
      if(selected && selected.k==='w' && selected.id===w.id) selected=null;
      save(); renderWaiters(); renderColumns(); refreshAllBriefs();
    });

    waiterRow.appendChild(chip);
  });
}

function renderBanquetBar(){
  banquetBar.innerHTML='';
  const addBtn=document.createElement('button'); addBtn.className='b-chip'; addBtn.textContent='+ –ë–∞–Ω–∫–µ—Ç';
  addBtn.onclick=()=>openBanquetModal();
  banquetBar.appendChild(addBtn);

  banquetsForDay().forEach(b=>{
    const meta=BANQUET_TYPES[b.type]||BANQUET_TYPES['–î—Ä—É–≥–æ–π'];
    const chip=document.createElement('div'); chip.className='b-chip'; if(selected&&selected.k==='b'&&selected.id===b.id) chip.classList.add('active');
    const title=(b.type==='–î—Ä—É–≥–æ–π' && b.other)? `–î—Ä—É–≥–æ–µ: ${b.other}` : meta;
    chip.textContent = `${title} ¬∑ ${b.people}`;
    const actions=document.createElement('span'); actions.className='b-actions';
    const edit=document.createElement('button'); edit.className='icon-btn'; edit.textContent='‚úèÔ∏è'; edit.title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    const del=document.createElement('button'); del.className='icon-btn'; del.textContent='üóë'; del.title='–£–¥–∞–ª–∏—Ç—å';
    edit.onclick=(e)=>{e.stopPropagation(); openBanquetModal(b);};
    del.onclick=(e)=>{e.stopPropagation(); deleteBanquet(b.id);};
    chip.appendChild(actions); actions.appendChild(edit); actions.appendChild(del);

    chip.addEventListener('click',()=>{ selected=(selected&&selected.k==='b'&&selected.id===b.id)?null:{k:'b',id:b.id}; renderBanquetBar(); renderWaiters(); },{passive:true});
    banquetBar.appendChild(chip);
  });
}
function deleteBanquet(id){
  const arr=banquetsForDay(); const i=arr.findIndex(x=>x.id===id); if(i>-1) arr.splice(i,1);
  const ass=getDayAss(); for(const hid in ass){ for(const pid in ass[hid]){ ass[hid][pid]=(ass[hid][pid]||[]).filter(x=>!(x.k==='b'&&x.id===id)); } }
  if(selected && selected.k==='b' && selected.id===id) selected=null;
  save(); renderBanquetBar(); renderColumns(); refreshAllBriefs();
}

/* ====== –ö–û–õ–û–ù–ö–ò + –ë–†–ò–§–´ ====== */
const hallTpl=document.getElementById('hallTpl'), posCardTpl=document.getElementById('posCardTpl');
const col1=document.getElementById('col1'), col2=document.getElementById('col2'), col3=document.getElementById('col3');
const hallBriefEls=new Map(); // hid -> span element

function renderColumns(){
  col1.innerHTML=''; col2.innerHTML=''; col3.innerHTML='';
  hallBriefEls.clear();
  const map=getHallsByName();

  ['–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª','–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª'].forEach(name=> mountHall(map[name], col1));
  ['–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã','–õ–æ—Ñ—Ç'].forEach(name=> mountHall(map[name], col2));        // –í–ò–ü + –õ–æ—Ñ—Ç
  ['–í–µ—Ä–∞–Ω–¥–∞','–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞'].forEach(name=> mountHall(map[name], col3));
  refreshAllBriefs();
}

function mountHall(h,into){
  if(!h) return;
  const sec=hallTpl.content.firstElementChild.cloneNode(true);
  sec.dataset.hid=h.id;
  sec.querySelector('.hall-title').textContent=h.name;
  const briefEl=sec.querySelector('.hall-brief');
  hallBriefEls.set(h.id, briefEl);
  const grid=sec.querySelector('.pos-grid');

  h.positions.forEach(p=>{
    const card=posCardTpl.content.firstElementChild.cloneNode(true);
    card.querySelector('.pos-title').textContent=p.name;
    const counter=card.querySelector('.counter');
    const slot=card.querySelector('.slot');
    const pick=card.querySelector('.pick');
    const addBtn=card.querySelector('.addBtn');

    fillPick(pick);

    const draw=()=>{
      const arr=ensureSlot(h.id,p.id);
      slot.innerHTML='';
      arr.forEach(ent=>{
        if(ent.k==='w'){
          const w=waiterById(ent.id); if(!w) return;
          const {bg,fg}=colorForWaiter(ent.id);
          const el=renderAssign(w.name, getNotes(ent.id), bg, fg, ()=>{ removeEnt(h.id,p.id,ent); draw(); });
          slot.appendChild(el);
        }else{
          const b=banquetById(ent.id); if(!b) return;
          const title=(b.type==='–î—Ä—É–≥–æ–π'&&b.other)?`–î—Ä—É–≥–æ–µ: ${b.other}`:(BANQUET_TYPES[b.type]||'–ë–∞–Ω–∫–µ—Ç');
          const label=`${title} ¬∑ ${b.people}`;
          const el=renderAssign(label, b.note? [b.note] : [], '#fff', '#0f172a', ()=>{ removeEnt(h.id,p.id,ent); draw(); });
          slot.appendChild(el);
        }
      });
      counter.textContent=String(arr.length);
      refreshHallBrief(h.id); // –æ–±–Ω–æ–≤–∏—Ç—å –±—Ä–∏—Ñ –∑–∞–ª–∞
    };

    function assign(hid,pid,ent){
      const arr=ensureSlot(hid,pid);
      if(arr.some(x=>x.k===ent.k && x.id===ent.id)) return;
      arr.push(ent); save(); draw();
    }
    function removeEnt(hid,pid,ent){
      const arr=ensureSlot(hid,pid); const i=arr.findIndex(x=>x.k===ent.k && x.id===ent.id);
      if(i>-1) arr.splice(i,1); save();
    }

    card.addEventListener('click',e=>{
      if(e.target.closest('.adder')||e.target.closest('.assign')) return;
      if(!selected) return;
      assign(h.id,p.id, selected);
    });
    addBtn.addEventListener('click',e=>{
      e.stopPropagation();
      const wid=pick.value; if(!wid) return;
      assign(h.id,p.id,{k:'w',id:wid});
      pick.value='';
    });

    draw();
    grid.appendChild(card);
  });

  into.appendChild(sec);
}

function refreshHallBrief(hid){
  const briefEl=hallBriefEls.get(hid); if(!briefEl) return;
  const hall=db.halls.find(x=>x.id===hid); if(!hall){ briefEl.textContent=''; briefEl.classList.remove('has'); return; }
  const ass=getDayAss();
  const parts=[];
  (hall.positions||[]).forEach(p=>{
    const arr=(ass[hid]&&ass[hid][p.id])||[];
    if(!arr.length) return;
    const people = arr.map(e=>{
      if(e.k==='w'){
        const w=waiterById(e.id); if(!w) return '‚Äî';
        const cm=getNotes(e.id); return w.name + (cm.length? ` (${cm.join(', ')})` : '');
      }else{
        const b=banquetById(e.id); if(!b) return '–ë–∞–Ω–∫–µ—Ç';
        const title=(b.type==='–î—Ä—É–≥–æ–π'&&b.other)?('–î—Ä—É–≥–æ–µ: '+b.other):(BANQUET_TYPES[b.type]||'–ë–∞–Ω–∫–µ—Ç');
        return `${title} ¬∑ ${b.people}`+(b.note?` (${b.note})`:'');
      }
    }).join(', ');
    parts.push(`${p.name}: ${people}`);
  });
  const txt=parts.join(' ‚Ä¢ ');
  briefEl.textContent=txt;
  briefEl.classList.toggle('has', !!txt);
}

function refreshAllBriefs(){
  db.halls.forEach(h=> refreshHallBrief(h.id));
}

/* ====== –†–ï–ù–î–ï–† –ò–ú–ï–ù–ò –í –°–õ–û–¢–ï ====== */
function renderAssign(name, notesArr, bg, fg, onRemove){
  const el=document.createElement('div'); el.className='assign';
  if(bg){ el.style.background=bg; el.style.borderColor=bg; }
  if(fg){ el.style.color=fg; }
  const top=document.createElement('div'); top.className='top';
  const nm=document.createElement('div'); nm.className='w-name'; nm.textContent=name;
  const x=document.createElement('button'); x.className='x'; x.title='–£–±—Ä–∞—Ç—å'; x.textContent='√ó';
  x.onclick=(e)=>{ e.stopPropagation(); onRemove(); };
  top.appendChild(nm); top.appendChild(x);
  const note=document.createElement('div'); note.className='w-note';
  note.textContent = (notesArr && notesArr.length) ? notesArr.join(', ') : '';
  el.appendChild(top); el.appendChild(note);
  return el;
}

/* ====== –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ====== */
function openCommentsModal(wid, wname){
  const presets=['–ü–æ–º–æ—â—å –Ω–∞ –≤–µ—Ä–∞–Ω–¥–µ 1','–ü–æ–º–æ—â—å –Ω–∞ –≤–µ—Ä–∞–Ω–¥–µ 2','–ü–æ–º–æ—â—å –≤ –û–ó','–ü–æ–º–æ—â—å –Ω–∞ –í–ò–ü–∞—Ö','–ü–æ–º–æ—â—å –≤ –ú–ë–ó','–ü–µ—Ä–≤—ã–π –Ω–æ–º–µ—Ä –Ω–∞ –±–∞–Ω–∫–µ—Ç–µ','–í—Ç–æ—Ä–æ–π –Ω–æ–º–µ—Ä –Ω–∞ –±–∞–Ω–∫–µ—Ç–µ'];
  const wrap=document.createElement('div'); wrap.className='modal';
  wrap.innerHTML = '<div class="dialog">'+
    '<div style="font-weight:900">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ‚Äî '+wname+'</div>'+
    '<div id="presetBox" style="display:flex;flex-wrap:wrap;gap:6px"></div>'+
    '<div id="tagList" style="display:flex;flex-wrap:wrap;gap:6px"></div>'+
    '<div class="row"><label>–ù–æ–≤—ã–π</label><input id="cInp" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –¥–æ 18:00"/></div>'+
    '<div class="row" style="justify-content:flex-end"><button id="cAdd" class="btn-acc">–î–æ–±–∞–≤–∏—Ç—å</button><button id="cClose">–ó–∞–∫—Ä—ã—Ç—å</button></div>'+
  '</div>';
  document.body.appendChild(wrap);

  const box=wrap.querySelector('#presetBox'), list=wrap.querySelector('#tagList'), inp=wrap.querySelector('#cInp');
  function redraw(){
    list.innerHTML='';
    getNotes(wid).forEach((t,i)=>{
      const tag=document.createElement('span');
      tag.style.cssText='font-size:11px;background:#eef2ff;border:1px solid #c7d2fe;border-radius:999px;padding:2px 8px;display:inline-flex;align-items:center;gap:6px';
      const x=document.createElement('b'); x.textContent='√ó'; x.style.cssText='cursor:pointer;color:#991b1b';
      x.onclick=()=>{ delNote(wid,i); redraw(); renderColumns(); refreshAllBriefs(); renderWaiters(); };
      tag.appendChild(document.createTextNode(t)); tag.appendChild(x); list.appendChild(tag);
    });
  }
  presets.forEach(p=>{
    const b=document.createElement('button'); b.textContent=p; b.className='btn-acc';
    b.style.cssText='border:1px dashed #cbd5e1;border-radius:999px;padding:4px 8px;background:#fff;font-size:11px';
    b.onclick=()=>{ const cur=getNotes(wid); const i=cur.indexOf(p); if(i===-1) addNote(wid,p); else delNote(wid,i); redraw(); renderColumns(); refreshAllBriefs(); renderWaiters(); };
    box.appendChild(b);
  });
  wrap.querySelector('#cAdd').onclick=()=>{ const v=(inp.value||'').trim(); if(!v) return; addNote(wid,v); inp.value=''; redraw(); renderColumns(); refreshAllBriefs(); renderWaiters(); };
  wrap.querySelector('#cClose').onclick=()=>wrap.remove();
  wrap.addEventListener('click',e=>{ if(e.target===wrap) wrap.remove(); });
  redraw();
}

/* ====== –ë–∞–Ω–∫–µ—Ç–Ω–∞—è –º–æ–¥–∞–ª–∫–∞ ====== */
function openBanquetModal(existing){
  const isEdit=!!existing;
  const wrap=document.createElement('div'); wrap.className='modal';
  wrap.innerHTML = '<div class="dialog">'+
    `<div style="font-weight:900">${isEdit?'–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–Ω–∫–µ—Ç':'–ù–æ–≤—ã–π –±–∞–Ω–∫–µ—Ç'}</div>`+
    '<div class="row"><label>–ö–æ–ª-–≤–æ –ø–µ—Ä—Å–æ–Ω</label><input id="bnPeople" type="number" min="1" inputmode="numeric" placeholder="25"/></div>'+
    '<div class="row"><label>–í–∏–¥</label><select id="bnType"><option>–î–†</option><option>–°–≤–∞–¥—å–±–∞</option><option>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤</option><option>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</option><option>–î–µ–Ω—å –ø–∞–º—è—Ç–∏</option><option>–î—Ä—É–≥–æ–π</option></select></div>'+
    '<div class="row" id="bnOtherRow" style="display:none"><label>–î—Ä—É–≥–æ–π</label><input id="bnOther"/></div>'+
    '<div class="row"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="bnNote" rows="3" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è, —Ç–∞–π–º–∏–Ω–≥..."></textarea></div>'+
    `<div class="row" style="justify-content:flex-end"><button id="bnSave" class="btn-acc">${isEdit?'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å'}</button><button id="bnClose">–ó–∞–∫—Ä—ã—Ç—å</button></div>`+
  '</div>';
  document.body.appendChild(wrap);
  const people=wrap.querySelector('#bnPeople'), type=wrap.querySelector('#bnType'), otherRow=wrap.querySelector('#bnOtherRow'), other=wrap.querySelector('#bnOther'), note=wrap.querySelector('#bnNote');
  type.onchange=()=>{ otherRow.style.display=(type.value==='–î—Ä—É–≥–æ–π')?'flex':'none'; };
  if(isEdit){ people.value=existing.people; type.value=existing.type; note.value=existing.note||''; if(existing.type==='–î—Ä—É–≥–æ–π'){ otherRow.style.display='flex'; if(other) other.value=existing.other||''; } }
  wrap.querySelector('#bnSave').onclick=()=>{
    const n=parseInt(people.value,10); if(!(n>0)) return alert('–£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ –ø–µ—Ä—Å–æ–Ω.');
    if(isEdit){ existing.people=n; existing.type=type.value; existing.other=(other&&other.value||'').trim(); existing.note=(note.value||'').trim(); }
    else { banquetsForDay().push({id:UUID(), people:n, type:type.value, other:(other&&other.value||'').trim(), note:(note.value||'').trim()}); }
    save(); renderBanquetBar(); renderColumns(); refreshAllBriefs(); wrap.remove();
  };
  wrap.querySelector('#bnClose').onclick=()=>wrap.remove();
  wrap.addEventListener('click',e=>{ if(e.target===wrap) wrap.remove(); });
}

/* ====== –í–µ—Ä—Ö–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ ====== */
document.getElementById('addWaiter').onclick=()=>{
  const wrap=document.createElement('div'); wrap.className='modal';
  wrap.innerHTML='<div class="dialog">'+
    '<div style="font-weight:900">–ù–æ–≤—ã–π –æ—Ñ–∏—Ü–∏–∞–Ω—Ç</div>'+
    '<div class="row"><label>–ò–º—è</label><input id="wName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–∞–≤–µ–ª"/></div>'+
    '<div class="row" style="justify-content:flex-end"><button id="wSave" class="btn-acc">–î–æ–±–∞–≤–∏—Ç—å</button><button id="wClose">–û—Ç–º–µ–Ω–∞</button></div>'+
  '</div>';
  document.body.appendChild(wrap);
  const input=wrap.querySelector('#wName');
  wrap.querySelector('#wSave').onclick=()=>{
    const name=(input.value||'').trim(); if(!name) return;
    if(db.waiters.some(w=>w.name.toLowerCase()===name.toLowerCase())) return alert('–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å.');
    db.waiters.push({id:UUID(), name}); save(); renderWaiters(); fillAllPicks(); wrap.remove();
  };
  wrap.querySelector('#wClose').onclick=()=>wrap.remove();
  wrap.addEventListener('click',e=>{ if(e.target===wrap) wrap.remove(); });
  setTimeout(()=>input.focus(),0);
};

document.getElementById('copy').onclick=async()=>{
  const txt=exportText(); try{ await navigator.clipboard.writeText(txt); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }catch(e){ alert('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:\n\n'+txt); }
};
document.getElementById('share').onclick=async()=>{
  const text=exportText(); try{ if(navigator.share){ await navigator.share({title:'–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ',text}); } else { await navigator.clipboard.writeText(text); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); } }catch{}
};
document.getElementById('resetDay').onclick=()=>{
  if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —ç—Ç—É –¥–∞—Ç—É?')) return;
  const k=dateKey(); db.assignments[k]={}; db.notes[k]={}; save(); renderColumns(); refreshAllBriefs(); renderWaiters();
};
document.getElementById('hardReset').onclick=()=>{
  if(!confirm('–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö?')) return;
  localStorage.removeItem(STORAGE_KEY); location.reload();
};
document.getElementById('date').onchange=()=>{ renderColumns(); refreshAllBriefs(); renderWaiters(); };

/* ====== –≠–∫—Å–ø–æ—Ä—Ç ====== */
function exportText(){
  const d=dateKey(); const lines=['–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ '+d];
  const ass=getDayAss();
  db.halls.forEach(h=>{
    lines.push('\n'+h.name+':');
    h.positions.forEach(p=>{
      const arr=(ass[h.id]&&ass[h.id][p.id])||[];
      if(!arr.length){ lines.push('‚Ä¢ '+p.name+': ‚Äî'); return; }
      const people=arr.map(e=>{
        if(e.k==='w'){ const w=waiterById(e.id); const cm=getNotes(e.id); return w?(w.name + (cm.length? ' ('+cm.join(', ')+')':'')):'‚Äî'; }
        const b=banquetById(e.id); if(!b) return '–ë–∞–Ω–∫–µ—Ç';
        const title=(b.type==='–î—Ä—É–≥–æ–π'&&b.other)?('–î—Ä—É–≥–æ–µ: '+b.other):(BANQUET_TYPES[b.type]||'–ë–∞–Ω–∫–µ—Ç');
        return `${title} ¬∑ ${b.people}`+(b.note?` (${b.note})`:'');
      }).join(' | ');
      lines.push('‚Ä¢ '+p.name+': '+people+'  ('+arr.length+')');
    });
  });
  const bl=banquetsForDay(); if(bl.length){ lines.push('\n–ë–∞–Ω–∫–µ—Ç—ã: '+ bl.map(b=> ( (b.type==='–î—Ä—É–≥–æ–π'&&b.other?('–î—Ä—É–≥–æ–µ: '+b.other):(BANQUET_TYPES[b.type]||'–ë–∞–Ω–∫–µ—Ç')) + ' ¬∑ '+b.people)).join('; ')); }
  return lines.join('\n');
}

/* ====== –°—Ç–∞—Ä—Ç ====== */
function renderAll(){ renderBanquetBar(); renderWaiters(); renderColumns(); refreshAllBriefs(); }
dateEl.value=todayISO();
renderAll();
</script>
</body>
</html>
