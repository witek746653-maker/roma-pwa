<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>Распределение — мобильная</title>
<style>
  :root{
    --ink:#3b2b2a;--bg:#ffffff;--panel:#fffdfc;--line:#8b5e57;--muted:#7a6662;
    --accent:#f5e6da;--active:#ffe9c4;--badge:#ffd84d;
  }
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.25 system-ui,-apple-system,Segoe UI,Roboto}
  button,input,select,textarea{font:inherit;color:inherit}
  .wrap{max-width:980px;margin:0 auto;padding:8px}
  .box{border:2px solid var(--line);border-radius:6px;background:var(--panel)}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .pad{padding:8px}
  .topbar{display:grid;grid-template-columns:1fr;gap:8px;margin-bottom:8px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .ctrl{border:2px solid var(--line);background:#fff;border-radius:6px;padding:6px 10px}
  .ctrl.primary{background:var(--accent)}
  .mini{font-size:12px;padding:4px 8px}
  .wday{min-width:160px}
  .grow{flex:1 1 auto}

  .badge{border:2px solid var(--line);background:var(--badge);color:#1f1a0f;
    border-radius:20px;padding:6px 12px;font-weight:700}

  .halls{display:flex;flex-wrap:wrap;gap:8px}
  .hall-btn{border:2px solid var(--line);background:#fff;border-radius:6px;padding:10px 12px;cursor:pointer}
  .hall-btn.active{background:var(--active)}

  .main{display:grid;grid-template-columns:1fr 1.2fr;gap:10px}
  @media (max-width:760px){ .main{grid-template-columns:1fr} }
  .left{display:grid;gap:10px}

  .banquets{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .b-chip{border:2px solid var(--line);background:#fff;border-radius:6px;padding:6px 8px;display:inline-flex;align-items:center;gap:6px}
  .b-chip .x{border:none;background:none;font-weight:900;font-size:16px;line-height:1;cursor:pointer}

  .waiters-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .waiters{border:2px solid var(--line);border-radius:6px;padding:8px;background:#fff}
  .w-title{font-weight:800}
  .w-row{display:flex;flex-wrap:wrap;gap:6px}

  .wchip{
    border:2px solid var(--line);background:#fff;border-radius:8px;min-width:88px;
    padding:6px 6px 4px; position:relative; display:inline-flex; flex-direction:column;
    align-items:center; gap:2px; cursor:pointer
  }
  .wchip.active{background:var(--active)}
  .w-main{display:flex;align-items:center;gap:6px}
  .w-name{font-weight:600}
  .w-tools{display:flex;gap:4px}
  .iconbtn{border:1px solid var(--line);background:#fff;border-radius:4px;padding:0 6px;line-height:18px;height:18px;cursor:pointer}
  .w-note{font-size:11px;color:var(--muted);max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  .toggle{border:2px solid var(--line);background:#fff;border-radius:6px;padding:6px 8px;cursor:pointer;width:100%;text-align:center;margin-top:6px}

  .count-pill{border:2px solid var(--line);background:#fff;border-radius:6px;padding:3px 8px;font-size:12px}
  .right .head{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .zones{border:2px solid var(--line);border-radius:6px;background:#fff;min-height:320px;padding:8px}
  .zone{border:2px dashed var(--line);border-radius:6px;padding:8px;margin:8px 0}
  .zone .zhead{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .zone .slot{display:flex;flex-wrap:wrap;gap:6px}
  .assign{border:2px solid var(--line);background:var(--accent);border-radius:6px;
    padding:4px 6px;display:inline-flex;gap:6px;align-items:center;flex-direction:column;min-width:88px}
  .assign .row1{display:flex;gap:6px;align-items:center}
  .assign .nm{font-weight:600}
  .assign .small{font-size:11px;color:var(--muted);max-width:120px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .assign .x{border:none;background:none;font-weight:900;font-size:16px;line-height:1;cursor:pointer}

  .muted{color:var(--muted)}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;padding:10px;z-index:50}
  .dialog{background:#fff;border:2px solid var(--line);border-radius:8px;max-width:95vw;max-height:95vh;overflow:auto}
  .dialog .pad{padding:10px}
</style>
</head>
<body>
<div class="wrap">

  <!-- ВЕРХ -->
  <div class="topbar box pad">
    <div class="controls">
      <div class="ctrl">
        <div class="muted mini">Календарь</div>
        <input id="date" type="date"/>
      </div>

      <div class="ctrl wday" id="wday">День недели<br/>Число.Месяц.</div>

      <!-- ЕДИНАЯ яркая кнопка с числом людей в смене -->
      <div id="shiftBadge" class="badge">В смене: 0</div>

      <button class="ctrl" id="sendBtn">Отправить</button>
      <button class="ctrl" id="resetBtn">Сбросить все</button>

      <div class="grow"></div>

      <button class="ctrl" id="refreshBtn">Обновить</button>
      <button class="ctrl" id="addTextBtn">Добавить текст</button>
      <button class="ctrl" id="saveBtn">Сохранить</button>
      <button class="ctrl" id="importBtn">Импорт</button>
      <input id="importFile" type="file" accept="application/json" style="display:none"/>
    </div>

    <div class="controls">
      <div class="muted">Банкеты</div>
      <div id="banquetPanel" class="banquets"></div>
      <button class="ctrl primary mini" id="addBanquetBtn">Добавить</button>
    </div>
  </div>

  <!-- КНОПКИ ЗАЛОВ -->
  <div class="box pad">
    <div class="muted mini" style="margin-bottom:6px">Залы</div>
    <div class="halls" id="hallBar"></div>
  </div>

  <!-- ОСНОВНОЙ МАКЕТ -->
  <div class="main">
    <div class="left">
      <div class="box pad">
        <div class="waiters-head">
          <div class="w-title">Официанты</div>
          <button class="ctrl mini" id="addWaiterBtn">Добавить</button>
        </div>
        <div class="waiters">
          <div class="muted mini">Смена 1</div>
          <div id="wRow1" class="w-row"></div>

          <button id="toggleShift2" class="toggle">Смена 2</button>
          <div id="wRow2Wrap" style="display:none;margin-top:6px">
            <div class="muted mini">Смена 2</div>
            <div id="wRow2" class="w-row"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="right">
      <div class="head">
        <div class="muted">Зоны</div>
        <div class="count-pill" id="zoneTitle">—</div>
        <button id="planBtn" class="ctrl mini" style="display:none">Схема</button>
      </div>
      <div class="zones" id="zonesBox"></div>
    </div>
  </div>
</div>

<!-- Модалка -->
<template id="modalTpl">
  <div class="modal"><div class="dialog"><div class="pad" id="modalBody"></div></div></div>
</template>

<script>
(function(){
'use strict';

/* ====== Константы / пресеты ====== */
const STORAGE='rota-mobile-v3';
const MAX_AGE_DAYS=60;
const DEFAULT_HALLS={
  'Основной зал':['Зона окна','5-я линия','Столы 7,8,9','Столы 10,11,12','Подиум'],
  'Малый (банкетный) зал':['МБЗ'],
  'ВИП-комнаты':['Большой ВИП','Малый ВИП','Каюта','Лиенда'],
  'Лофт':['Лофт'],
  'Веранда':['Веранда 1','Веранда 2'],
  'Винная комната':['Винная комната']
};
const SH1=['Элона','Полина','Настя','Виктор','Натали Ч.','Рома','Ксюша'];
const SH2=['Юля','Игорь','Катя','Наташа В.','Наташа Вел.','Артем','Маша','Инна','Лёша'];
const BANQUET_TYPES=['ДР','Юбилей','День памяти','Корпоратив','Конференция','Свадьба'];
const NOTE_PRESETS=[
  'Помощь в ОЗ','Помощь на ВИПах','Помощь в МБЗ',
  'Помощь на Веранде 1','Помощь на Веранде 2',
  'Доставка','1-ый номер','2-ой номер'
];

const $=s=>document.querySelector(s), modalTpl=$('#modalTpl');

/* ====== Вспомогательные ====== */
function todayISO(){ const z=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-z).toISOString().slice(0,10); }
function weekday(iso){ const d=new Date(iso+'T00:00'); return ['воскресенье','понедельник','вторник','среда','четверг','пятница','суббота'][d.getDay()]; }
function fmtDate(iso){ const [y,m,d]=iso.split('-'); return `${d}.${m}.${y}`; }
function modal(){ const host=modalTpl.content.firstElementChild.cloneNode(true); const body=host.querySelector('#modalBody'); function close(){ host.remove(); } host.addEventListener('click',e=>{ if(e.target===host) close(); }); document.body.appendChild(host); return {el:host,body,close}; }

/* ====== База ====== */
function defaultDB(){ return {waiters:{shift1:[...SH1],shift2:[...SH2]}, halls:JSON.parse(JSON.stringify(DEFAULT_HALLS)), data:{}}; }
let db=load()||defaultDB();
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE));}catch{return null} }
function save(){ localStorage.setItem(STORAGE, JSON.stringify(db)); }
function purgeOld(){ const now=new Date(todayISO()+'T00:00'); const day=86400000; for(const k of Object.keys(db.data)){ const d=new Date(k+'T00:00'); if((now-d)/day>MAX_AGE_DAYS) delete db.data[k]; } }
purgeOld(); save();

function curDay(){ return $('#date').value||todayISO(); }
function dayData(){ const k=curDay(); db.data[k] ||= {assign:{},banquets:[],extraText:'',wNotes:{}}; return db.data[k]; }

/* ====== Верх ====== */
function renderTop(){ const iso=curDay(); $('#wday').innerHTML=`${weekday(iso)}<br>${fmtDate(iso)}.`; }

/* ====== Залы/зоны ====== */
let currentHall='Основной зал';
function renderHalls(){ const bar=$('#hallBar'); bar.innerHTML=''; Object.keys(db.halls).forEach(h=>{ const b=document.createElement('button'); b.className='hall-btn'; b.textContent=h; if(h===currentHall) b.classList.add('active'); b.onclick=()=>{ currentHall=h; renderHalls(); renderZones(); }; bar.appendChild(b); }); }
function ensureHallZone(h,z){ const d=dayData(); d.assign[h] ||= {}; d.assign[h][z] ||= []; return d.assign[h][z]; }

function renderZones(){
  $('#zoneTitle').textContent=currentHall;
  const planBtn=$('#planBtn'); planBtn.style.display=(currentHall==='Основной зал')?'inline-block':'none';

  const box=$('#zonesBox'); box.innerHTML='';
  (db.halls[currentHall]||[]).forEach(z=>{
    const wrap=document.createElement('div'); wrap.className='zone';
    const head=document.createElement('div'); head.className='zhead'; head.innerHTML=`<strong>${z}</strong>`;
    wrap.appendChild(head);
    const slot=document.createElement('div'); slot.className='slot'; wrap.appendChild(slot);

    const draw=()=>{
      slot.innerHTML='';
      const arr=ensureHallZone(currentHall,z);
      arr.forEach((e,i)=>{
        const item=document.createElement('div'); item.className='assign';
        const row=document.createElement('div'); row.className='row1';
        if(e.t==='w'){ row.innerHTML=`<span class="nm">${e.name}</span> <button class="x" title="Удалить">×</button>`; }
        else { row.innerHTML=`<span class="nm">Банкет</span> <button class="x" title="Удалить">×</button>`; }
        const note = (e.t==='w') ? (dayData().wNotes[e.name]||'') : '';
        const under=document.createElement('div'); under.className='small'; under.textContent=note;
        item.appendChild(row); if(note) item.appendChild(under);
        row.querySelector('.x').onclick=()=>{ arr.splice(i,1); save(); draw(); updateShiftBadge(); };
        slot.appendChild(item);
      });
    };
    draw();

    wrap.addEventListener('click',()=>{
      if(!selected) return;
      const arr=ensureHallZone(currentHall,z);
      if(selected.kind==='w'){
        if(!arr.some(x=>x.t==='w'&&x.name===selected.name)){ arr.push({t:'w',name:selected.name}); }
      }else if(selected.kind==='b'){
        if(!arr.some(x=>x.t==='b'&&x.id===selected.id)){ arr.push({t:'b',id:selected.id}); const b=dayData().banquets.find(x=>x.id===selected.id); if(b){ b.place={hall:currentHall,zone:z}; } }
      }
      save(); draw(); updateShiftBadge();
    });

    box.appendChild(wrap);
  });
}

/* схема */
$('#planBtn').addEventListener('click',()=>{ const host=modal(); host.body.innerHTML=`<div class="muted mini" style="margin-bottom:6px">Схема: Основной зал</div><img src="oz-scheme.png" alt="Схема" style="max-width:92vw;max-height:82vh;display:block"/><div class="row" style="justify-content:flex-end;margin-top:8px"><a class="ctrl mini" href="oz-scheme.png" target="_blank" rel="noopener">Открыть</a><button class="ctrl mini" id="c">Закрыть</button></div>`; host.body.querySelector('#c').onclick=host.close; });

/* ====== Официанты (выбор, удаление, комментарии) ====== */
let selected=null; // {kind:'w'|'b', name?, id?}

function waiterChip(name){
  const note=dayData().wNotes[name]||'';
  const chip=document.createElement('div'); chip.className='wchip'; if(selected&&selected.kind==='w'&&selected.name===name) chip.classList.add('active');

  const main=document.createElement('div'); main.className='w-main';
  const nm=document.createElement('div'); nm.className='w-name'; nm.textContent=name;
  const tools=document.createElement('div'); tools.className='w-tools';
  const edit=document.createElement('button'); edit.className='iconbtn'; edit.title='Комментарий'; edit.textContent='✎';
  const del=document.createElement('button'); del.className='iconbtn'; del.title='Удалить имя'; del.textContent='×';
  tools.append(edit,del); main.append(nm,tools);

  const sub=document.createElement('div'); sub.className='w-note'; sub.textContent=note;

  chip.append(main, sub);

  chip.addEventListener('click',(e)=>{ if(e.target===edit||e.target===del) return; selected = (selected&&selected.kind==='w'&&selected.name===name)?null:{kind:'w',name}; highlightWaiters(); });

  edit.addEventListener('click',(e)=>{ e.stopPropagation(); editNoteModal(name); });

  del.addEventListener('click',(e)=>{
    e.stopPropagation();
    if(!confirm(`Удалить "${name}" и убрать из зон?`)) return;
    // убрать из списков
    db.waiters.shift1 = db.waiters.shift1.filter(n=>n!==name);
    db.waiters.shift2 = db.waiters.shift2.filter(n=>n!==name);
    // убрать из назначений текущего дня
    const d=dayData();
    Object.values(d.assign).forEach(zmap=>{
      Object.keys(zmap).forEach(z=>{
        zmap[z]=zmap[z].filter(e=>!(e.t==='w'&&e.name===name));
      });
    });
    delete d.wNotes[name];
    if(selected&&selected.kind==='w'&&selected.name===name) selected=null;
    save(); renderWaiters(); renderZones(); updateShiftBadge();
  });

  return chip;
}

function renderWaiters(){
  const row1=$('#wRow1'), row2=$('#wRow2');
  row1.innerHTML=''; row2.innerHTML='';
  db.waiters.shift1.forEach(n=>row1.appendChild(waiterChip(n)));
  db.waiters.shift2.forEach(n=>row2.appendChild(waiterChip(n)));
}
function highlightWaiters(){
  document.querySelectorAll('.wchip').forEach(el=>{
    const name=el.querySelector('.w-name')?.textContent||'';
    if(selected && selected.kind==='w' && selected.name===name) el.classList.add('active'); else el.classList.remove('active');
  });
}

/* комментарий для имени */
function editNoteModal(name){
  const host=modal();
  const d=dayData();
  const cur=d.wNotes[name]||'';
  host.body.innerHTML=`
    <div class="muted mini" style="margin-bottom:6px">Комментарий для: <strong>${name}</strong></div>
    <div class="row" style="gap:6px;flex-wrap:wrap;margin-bottom:6px">
      ${NOTE_PRESETS.map(t=>`<button class="ctrl mini preset">${t}</button>`).join('')}
    </div>
    <div class="row" style="gap:6px;align-items:flex-end">
      <div style="flex:1">
        <div class="muted mini">Свой комментарий</div>
        <input id="own" class="ctrl" placeholder="Текст..." value="${cur.replace(/"/g,'&quot;')}"/>
      </div>
      <button id="ok" class="ctrl primary">OK</button>
      <button id="clr" class="ctrl">Очистить</button>
    </div>`;
  host.body.querySelectorAll('.preset').forEach(btn=>{
    btn.onclick=()=>{ d.wNotes[name]=btn.textContent; save(); renderWaiters(); renderZones(); host.close(); };
  });
  host.body.querySelector('#ok').onclick=()=>{ d.wNotes[name]=host.body.querySelector('#own').value.trim(); save(); renderWaiters(); renderZones(); host.close(); };
  host.body.querySelector('#clr').onclick=()=>{ delete d.wNotes[name]; save(); renderWaiters(); renderZones(); host.close(); };
}

/* добавить имя */
function addWaiterModal(){
  const host=modal();
  host.body.innerHTML=`
    <div class="row" style="gap:6px;align-items:flex-end">
      <div style="flex:1">
        <div class="muted mini">Имя</div>
        <input id="nm" class="ctrl" placeholder="Например: Павел"/>
      </div>
      <div>
        <div class="muted mini">Смена</div>
        <select id="sh" class="ctrl"><option value="1">1-я</option><option value="2">2-я</option></select>
      </div>
      <button id="go" class="ctrl primary">Добавить</button>
      <button id="cl" class="ctrl">Отмена</button>
    </div>`;
  host.body.querySelector('#go').onclick=()=>{
    const nm=(host.body.querySelector('#nm').value||'').trim(); const sh=host.body.querySelector('#sh').value;
    if(!nm) return alert('Введите имя');
    if(db.waiters.shift1.includes(nm)||db.waiters.shift2.includes(nm)) return alert('Такое имя уже есть');
    if(sh==='1') db.waiters.shift1.push(nm); else db.waiters.shift2.push(nm);
    save(); renderWaiters(); host.close();
  };
  host.body.querySelector('#cl').onclick=host.close;
}

/* ====== Банкеты (как было) ====== */
function banquetTitle(id){ const b=dayData().banquets.find(x=>x.id===id); if(!b) return 'Банкет'; const place=b.place?(b.place.zone?`${b.place.hall} — ${b.place.zone}`:b.place.hall):'—'; return `${b.type}, ${b.people} чел, ${place}${b.note?`, ${b.note}`:''}`; }
function renderBanquets(){ const p=$('#banquetPanel'); p.innerHTML=''; dayData().banquets.forEach(b=>{ const chip=document.createElement('span'); chip.className='b-chip'; chip.textContent=banquetTitle(b.id); chip.onclick=()=>{ selected=(selected&&selected.kind==='b'&&selected.id===b.id)?null:{kind:'b',id:b.id}; highlightWaiters(); }; const x=document.createElement('button'); x.className='x'; x.title='Удалить'; x.textContent='×'; x.onclick=(ev)=>{ ev.stopPropagation(); const d=dayData(); Object.values(d.assign).forEach(zmap=>{ Object.keys(zmap).forEach(z=>{ zmap[z]=(zmap[z]||[]).filter(e=>!(e.t==='b'&&e.id===b.id)); }); }); d.banquets=d.banquets.filter(x=>x.id!==b.id); save(); renderBanquets(); renderZones(); }; chip.appendChild(x); p.appendChild(chip); }); }
function addBanquetModal(){
  const host=modal(); const halls=Object.keys(db.halls); const hallOpts=halls.map(h=>`<option>${h}</option>`).join('');
  host.body.innerHTML=`
    <div class="row" style="flex-wrap:wrap;gap:8px">
      <div><div class="muted mini">Мероприятие</div><select id="type" class="ctrl">${BANQUET_TYPES.map(t=>`<option>${t}</option>`).join('')}</select></div>
      <div><div class="muted mini">Кол-во</div><input id="peo" class="ctrl" type="number" min="1" inputmode="numeric" placeholder="25"/></div>
      <div><div class="muted mini">Зал</div><select id="hall" class="ctrl">${hallOpts}</select></div>
      <div><div class="muted mini">Зона</div><select id="zone" class="ctrl"></select></div>
      <div style="flex:1 1 100%"><div class="muted mini">Комментарий</div><input id="note" class="ctrl" placeholder="Пожелания, тайминг..."/></div>
      <div class="row" style="gap:8px;margin-top:4px"><button id="ok" class="ctrl primary">Добавить</button><button id="cl" class="ctrl">Отмена</button></div>
    </div>`;
  const hallSel=host.body.querySelector('#hall'), zoneSel=host.body.querySelector('#zone');
  function fill(){ zoneSel.innerHTML=''; (db.halls[hallSel.value]||[]).forEach(z=>{ const o=document.createElement('option'); o.textContent=z; zoneSel.appendChild(o); }); }
  hallSel.onchange=fill; fill();
  host.body.querySelector('#ok').onclick=()=>{ const t=host.body.querySelector('#type').value; const p=parseInt(host.body.querySelector('#peo').value||'0',10); const note=host.body.querySelector('#note').value.trim(); const hall=hallSel.value; const zone=zoneSel.value; if(!(p>0)) return alert('Укажите количество человек'); const id='b'+Math.random().toString(36).slice(2); const rec={id,type:t,people:p,note,place:{hall,zone}}; const d=dayData(); d.banquets.push(rec); d.assign[hall] ||= {}; d.assign[hall][zone] ||= []; if(!d.assign[hall][zone].some(x=>x.t==='b'&&x.id===id)) d.assign[hall][zone].push({t:'b',id}); save(); renderBanquets(); renderZones(); host.close(); };
  host.body.querySelector('#cl').onclick=host.close;
}

/* ====== Экспорт/Импорт/WA ====== */
function buildMessage(){
  const iso=curDay(), d=dayData(), lines=[];
  lines.push('Добрый день, друзья!'); lines.push(`${fmtDate(iso)} (${weekday(iso)})`);
  lines.push(`В смене ${countUniqueAssigned()} человек. 🕺`);
  if(d.banquets.length===0) lines.push('Банкеты: 0');
  else{ lines.push('Банкеты:'); d.banquets.forEach(b=>lines.push(`• ${banquetTitle(b.id)}`)); }
  Object.keys(d.assign).forEach(h=>{
    const zones=d.assign[h]; const non=Object.keys(zones).filter(z=>(zones[z]||[]).length>0);
    if(!non.length) return; lines.push(''); lines.push(`*${h}*`);
    non.forEach(z=>{ const arr=zones[z]; const text=arr.map(e=> e.t==='w' ? (e.name+(d.wNotes[e.name]?` (${d.wNotes[e.name]})`:'')) : 'Банкет').join(', '); lines.push(`• ${z}: ${text}`); });
  });
  const extra=d.extraText; if(extra){ lines.push(''); lines.push(extra); }
  lines.push(''); lines.push('Всем хорошей смены и больших чаевых! 💵');
  return lines.join('\n');
}
function sendWhatsApp(){ const txt=buildMessage(); const app='whatsapp://send?text='+encodeURIComponent(txt); const web='https://wa.me/?text='+encodeURIComponent(txt); const a=document.createElement('a'); a.href=app; document.body.appendChild(a); a.click(); setTimeout(()=>{ window.open(web,'_blank'); a.remove(); },300); }
function saveToFile(){ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`rota-${curDay()}.json`; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); },0); }
function importFromFile(file){ const r=new FileReader(); r.onload=()=>{ try{ const obj=JSON.parse(r.result); if(obj&&obj.waiters&&obj.halls&&obj.data){ db=obj; purgeOld(); save(); renderAll(); alert('Импортирован полный бэкап.'); return; } if(obj&&(obj.assign||obj.banquets||obj.extraText!==undefined||obj.wNotes)){ const k=curDay(); db.data[k]={assign:obj.assign||{},banquets:obj.banquets||[],extraText:obj.extraText||'',wNotes:obj.wNotes||{}}; purgeOld(); save(); renderAll(); alert('Импортированы данные текущего дня.'); return; } alert('Неизвестный формат JSON.'); }catch(e){ alert('Ошибка импорта: '+e.message); } }; r.readAsText(file); }

/* ====== Счётчик людей ====== */
function countUniqueAssigned(){ const d=dayData(); const used=new Set(); Object.values(d.assign).forEach(zmap=>{ Object.values(zmap).forEach(arr=>{ arr.filter(x=>x.t==='w').forEach(x=>{ used.add(x.name); }); }); }); return used.size; }
function updateShiftBadge(){ $('#shiftBadge').textContent=`В смене: ${countUniqueAssigned()}`; }

/* ====== Инициализация ====== */
function renderAll(){ renderTop(); renderHalls(); renderZones(); renderWaiters(); renderBanquets(); updateShiftBadge(); }
document.addEventListener('DOMContentLoaded',()=>{
  const dEl=$('#date'); dEl.value=dEl.value||todayISO(); dEl.onchange=()=>{ renderAll(); save(); };
  renderAll();
  $('#toggleShift2').onclick=()=>{ const w=$('#wRow2Wrap'); w.style.display=(w.style.display==='none')?'block':'none'; };
  $('#addWaiterBtn').onclick=addWaiterModal;
  $('#addBanquetBtn').onclick=addBanquetModal;
  $('#sendBtn').onclick=sendWhatsApp;
  $('#addTextBtn').onclick=()=>{ const host=modal(); host.body.innerHTML=`<div class="muted mini" style="margin-bottom:6px">Добавить текст в конец сообщения</div><textarea id="x" class="ctrl" rows="4" style="width:100%">${dayData().extraText||''}</textarea><div class="row" style="gap:8px;margin-top:6px"><button id="ok" class="ctrl primary">OK</button><button id="cl" class="ctrl">Отмена</button></div>`; host.body.querySelector('#ok').onclick=()=>{ dayData().extraText=host.body.querySelector('#x').value||''; save(); host.close(); }; host.body.querySelector('#cl').onclick=host.close; };
  $('#saveBtn').onclick=saveToFile;
  $('#refreshBtn').onclick=()=>location.reload();
  $('#resetBtn').onclick=()=>{ if(!confirm('Очистить всю информацию за выбранный день?')) return; const k=curDay(); db.data[k]={assign:{},banquets:[],extraText:'',wNotes:{}}; save(); renderAll(); };
  const fileInput=$('#importFile'); $('#importBtn').onclick=()=>fileInput.click(); fileInput.onchange=(e)=>{ const f=e.target.files&&e.target.files[0]; if(f) importFromFile(f); e.target.value=''; };
});
})();
</script>
</body>
</html>
