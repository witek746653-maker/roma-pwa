<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
<meta name="format-detection" content="telephone=no" />
<title>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Äî v20 auto-update</title>

<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="apple-touch-icon" href="icons/icon-192.png">

<style>
  :root{ --bg:#fff; --text:#0f172a; --muted:#6b7280; --accent:#2563eb; --border:#e5e7eb; --panel:#f8fafc; --danger:#ef4444; }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%; width:100%}
  body{margin:0; font:13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Noto Sans,sans-serif; background:var(--bg); color:var(--text); overflow-x:hidden}

  .header{ position:sticky; top:0; z-index:10; display:grid; grid-template-columns:1fr; gap:8px;
    padding:10px; border-bottom:1px solid var(--border); background:rgba(255,255,255,.98); backdrop-filter:saturate(1.05) blur(2px) }
  @media (min-width:900px){ .header{ grid-template-columns:auto 1fr auto; align-items:start } }

  .left{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  label{font-size:11px; color:var(--muted)}
  .field{display:flex; flex-direction:column; gap:4px}
  input[type="date"]{ border:1px solid var(--border); border-radius:10px; padding:8px 10px; min-height:36px; background:#fff; color:#000; font-size:14px }
  button{ appearance:none; border:1px solid var(--border); background:#fff; color:#0f172a; padding:8px 10px; min-height:36px; border-radius:10px; font-size:13px; cursor:pointer }
  button:active{transform:scale(.98)}
  .btn-acc{border-color:rgba(37,99,235,.35)}
  .btn-danger{border-color:rgba(239,68,68,.45); color:#b91c1c}
  .btn-link{border:none; background:transparent; color:#2563eb; text-decoration:underline; padding:0 6px}

  .center{display:flex; align-items:center; gap:8px; flex-wrap:wrap; justify-content:center}
  .b-chip{border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#fff; display:inline-flex; gap:6px; align-items:center; font-weight:700; font-size:13px; cursor:pointer; max-width:100%}
  .b-chip.active{outline:2px solid rgba(37,99,235,.25)}
  .b-dot{width:12px;height:12px;border-radius:999px;border:1px solid #0002; flex:0 0 auto}
  .b-actions{display:inline-flex; gap:4px}
  .icon-btn{border:1px solid var(--border); background:#fff; border-radius:7px; padding:4px 6px; font-size:12px}
  .b-add{margin-left:4px}

  .waiters{ display:grid; grid-auto-flow:column; grid-template-rows:repeat(2,auto); gap:6px 8px; overflow-x:auto; padding-bottom:2px; justify-items:start; -webkit-overflow-scrolling:touch; max-width:100% }
  .chip{border:1px solid #c7d2fe; border-radius:999px; padding:6px 10px; background:#eef2ff; color:#0b1e4a; display:inline-flex; align-items:center; gap:6px; max-width:100%}
  .chip .name{font-weight:800; font-size:13px}
  .chip .note-dot{font-size:12px; color:#374151}
  .chip .edit{border:1px solid var(--border); border-radius:8px; padding:2px 6px; background:#fff; font-size:12px}
  .chip .del{border:none; background:transparent; color:#991b1b; font-weight:900; font-size:16px; line-height:1; padding:0 4px; cursor:pointer}
  .chip.active{outline:2px solid rgba(37,99,235,.25)}

  .columns{display:grid; gap:10px; padding:10px; max-width:100%}
  @media (min-width:1000px){ .columns{ grid-template-columns:repeat(3,1fr) } }
  @media (max-width:999px){ .columns{ grid-template-columns:1fr } }

  details.panel{background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:8px; overflow:hidden}
  summary{list-style:none; cursor:pointer; display:flex; align-items:center; gap:8px}
  summary::-webkit-details-marker{display:none}
  .hall-ico{font-size:15px}
  .hall-title{font-weight:900; font-size:14px; margin:0}

  .pos-grid{display:grid; grid-template-columns:1fr; gap:10px; margin-top:8px}
  .pos-card{background:#fff; border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px}
  .pos-head{display:flex; align-items:center; gap:8px}
  .pos-ico{font-size:14px}
  .pos-title{font-weight:800; font-size:13px}
  .muted{color:var(--muted); font-size:12px}

  .slot{ display:flex; flex-wrap:wrap; gap:8px; border:2px dashed #e2e8f0; border-radius:10px; padding:8px; min-height:44px; width:100% }
  .slot.highlight{border-color:var(--accent)}
  .assign{ display:flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:#fafafa; flex:1 1 calc(50% - 8px); min-width:140px; max-width:100% }
  @media (min-width:640px){ .assign{flex:1 1 calc(33.333% - 8px)} }
  .dot{width:12px;height:12px;border-radius:999px;border:1px solid #0002;flex:0 0 auto}
  .assign .w-name{font-weight:800; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .assign .w-note{font-size:11px; color:#6b7280; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
  .assign .x{margin-left:auto; border:none; background:transparent; color:#991b1b; font-weight:900; font-size:16px; line-height:1; cursor:pointer; padding:0 4px}
  .assign .x:active{transform:scale(.9)}

  .modal{position:fixed; inset:0; background:rgba(0,0,0,.28); display:flex; align-items:center; justify-content:center; padding:12px; z-index:40}
  .dialog{background:#fff; border:1px solid var(--border); border-radius:14px; width:min(560px,96vw); padding:12px; display:flex; flex-direction:column; gap:10px}
  .row{display:flex; gap:8px; align-items:center}
  .row>label{min-width:120px; color:var(--muted); font-size:13px}
  .row>input,.row>select,.row>textarea{ flex:1; border:1px solid var(--border); border-radius:10px; padding:8px 10px; font-size:14px }
  .row>textarea{min-height:80px}
  .tags{display:flex; gap:6px; flex-wrap:wrap}
  .tag{font-size:12px; background:#eef2ff; border:1px solid #c7d2fe; border-radius:999px; padding:2px 10px; display:inline-flex; gap:6px; align-items:center}
  .tag .x{cursor:pointer; font-weight:800}
  .presets{display:flex; flex-wrap:wrap; gap:6px}
  .preset{border:1px dashed #cbd5e1; border-radius:999px; padding:5px 10px; cursor:pointer; font-size:12px}
  .preset.on{background:#e2e8f0; border-style:solid}

  .update-banner{display:none; position:fixed; bottom:12px; left:12px; right:12px; background:#fff; border:1px solid var(--border); border-radius:10px; padding:10px; box-shadow:0 6px 18px rgba(0,0,0,.08); z-index:99}
  .update-banner.show{display:flex; align-items:center; justify-content:space-between; gap:10px}
</style>
</head>
<body>
  <div class="header">
    <div class="left">
      <div class="field">
        <label for="date">–î–∞—Ç–∞</label>
        <input id="date" type="date" />
      </div>
      <button id="addWaiter" class="btn-acc">–î–æ–±–∞–≤–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞</button>
      <button id="share" class="btn-acc">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
      <button id="copy">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button id="resetDay" class="btn-danger">–û—á–∏—Å—Ç–∏—Ç—å</button>
      <button id="hardReset" title="–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>
      <button id="refreshApp" class="btn-link" title="–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ">–û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</button>
    </div>

    <div class="center" id="banquetBar" aria-label="–ë–∞–Ω–∫–µ—Ç—ã"></div>
    <div class="waiters" id="waiterRow" aria-label="–û—Ñ–∏—Ü–∏–∞–Ω—Ç—ã"></div>
  </div>

  <div class="columns">
    <div class="col" id="col1"></div>
    <div class="col" id="col2"></div>
    <div class="col" id="col3"></div>
  </div>

  <div class="update-banner" id="upd">
    –î–æ—Å—Ç—É–ø–Ω–∞ –Ω–æ–≤–∞—è –≤–µ—Ä—Å–∏—è. <button id="updBtn" class="btn-acc">–û–±–Ω–æ–≤–∏—Ç—å</button>
  </div>

  <!-- Templates -->
  <template id="chipTpl">
    <div class="chip" tabindex="0">
      <span class="name"></span>
      <span class="note-dot"></span>
      <button class="edit" title="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏">üí¨</button>
      <button class="del" title="–£–¥–∞–ª–∏—Ç—å –æ—Ñ–∏—Ü–∏–∞–Ω—Ç–∞">√ó</button>
    </div>
  </template>

  <template id="hallTpl">
    <details class="panel" open>
      <summary><span class="hall-ico"></span><span class="hall-title"></span></summary>
      <div class="pos-grid"></div>
    </details>
  </template>

  <template id="posCardTpl">
    <div class="pos-card">
      <div class="pos-head">
        <span class="pos-ico">ü™ë</span>
        <div class="pos-title"></div>
        <div class="muted counter" style="margin-left:auto"></div>
      </div>
      <div class="slot"></div>
    </div>
  </template>

<script>
'use strict';
(function(){ try{ boot(); }catch(e){ console.error(e); alert('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏. –ù–∞–∂–º–∏ ¬´–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë¬ª –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏.'); } })();

function boot(){
const UUID=(crypto&&crypto.randomUUID)?()=>crypto.randomUUID():()=>('id-'+Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8));
const fmtRU=iso=>{const [y,m,d]=iso.split('-');return `${d}.${m}.${y}`;}
const esc=s=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

const STORAGE_KEY='waiters-rota-v20';
const SLOT_LIMIT=7;
const CHIP_COLORS=[['#E3F2FD','#0b1e4a'],['#FCE7F3','#3e1a36'],['#E8F5E9','#103b1f'],['#FFF3E0','#4a2f0b'],['#F3E8FF','#2e1065'],['#E0F2F1','#083d3b'],['#FFFDE7','#3a3000'],['#F1F5F9','#0f172a'],['#FFE4E6','#4a0b15'],['#EDE7F6','#1f1147']];
const BANQUET_TYPES={'–î–†':{label:'üéâ –î–†',bg:'#FFF1D6',fg:'#7a3d00'},'–°–≤–∞–¥—å–±–∞':{label:'üíç –°–≤–∞–¥—å–±–∞',bg:'#FFE8F2',fg:'#7a003a'},'–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤':{label:'üè¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤',bg:'#E8F7FF',fg:'#0b3d5a'},'–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è':{label:'üì£ –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è',bg:'#E8EEFF',fg:'#1a2a7a'},'–î–µ–Ω—å –ø–∞–º—è—Ç–∏':{label:'üïØÔ∏è –î–µ–Ω—å –ø–∞–º—è—Ç–∏',bg:'#F4F4F5',fg:'#111827'},'–î—Ä—É–≥–æ–π':{label:'üè∑Ô∏è –î—Ä—É–≥–æ–µ',bg:'#EAFBEA',fg:'#104a20'}};
const PRESET_COMMENTS=['–ü–æ–º–æ—â—å –Ω–∞ –≤–µ—Ä–∞–Ω–¥–µ 1','–ü–æ–º–æ—â—å –Ω–∞ –≤–µ—Ä–∞–Ω–¥–µ 2','–ü–æ–º–æ—â—å –≤ –û–ó','–ü–æ–º–æ—â—å –Ω–∞ –í–ò–ü–∞—Ö','–ü–æ–º–æ—â—å –≤ –ú–ë–ó','–ü–µ—Ä–≤—ã–π –Ω–æ–º–µ—Ä –Ω–∞ –±–∞–Ω–∫–µ—Ç–µ','–í—Ç–æ—Ä–æ–π –Ω–æ–º–µ—Ä –Ω–∞ –±–∞–Ω–∫–µ—Ç–µ'];
const CANON_HALLS=[{name:'–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª',positions:['–ó–æ–Ω–∞ –æ–∫–Ω–∞','5-—è –ª–∏–Ω–∏—è','–°—Ç–æ–ª—ã 7, 8, 9','–°—Ç–æ–ª—ã 10, 11, 12','–ü–æ–¥–∏—É–º']},{name:'–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª',positions:['']},{name:'–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã',positions:['–ë–æ–ª—å—à–æ–π –í–ò–ü','–ú–∞–ª—ã–π –í–ò–ü','–ö–∞—é—Ç–∞','–õ–∏–µ–Ω–¥–∞']},{name:'–í–µ—Ä–∞–Ω–¥–∞',positions:['–í–µ—Ä–∞–Ω–¥–∞ 1','–í–µ—Ä–∞–Ω–¥–∞ 2']},{name:'–õ–æ—Ñ—Ç',positions:['']},{name:'–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞',positions:['']}];

function buildFreshDB(){
  return {
    halls: CANON_HALLS.map(h=>({id:UUID(),name:h.name,positions:h.positions.map(n=>({id:UUID(),name:n}))})),
    waiters:['–ò–≥–æ—Ä—å','–í–∏–∫—Ç–æ—Ä','–†–æ–º–∞–Ω','–≠–ª–æ–Ω–∞','–ü–æ–ª–∏–Ω–∞','–ö—Å–µ–Ω–∏—è','–ù–∞—Ç–∞–ª—å—è –ß.','–ù–∞—Ç–∞–ª—å—è –í.','–ê–Ω–∞—Å—Ç–∞—Å–∏—è','–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞'].map(n=>({id:UUID(),name:n})),
    assignments:{}, banquets:{}, dayNotes:{}
  };
}
function load(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY));}catch{return null;} }
function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); }

let db = load() || buildFreshDB();

const dateEl=document.getElementById('date');
const waiterRow=document.getElementById('waiterRow');
const banquetBar=document.getElementById('banquetBar');
const col1=document.getElementById('col1'), col2=document.getElementById('col2'), col3=document.getElementById('col3');
const chipTpl=document.getElementById('chipTpl'), hallTpl=document.getElementById('hallTpl'), posCardTpl=document.getElementById('posCardTpl');
let selected=null;

function todayISO(){const tz=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-tz).toISOString().slice(0,10);}
function dateKey(){return dateEl.value || todayISO();}
function getDayAssignments(){const k=dateKey(); if(!db.assignments[k]) db.assignments[k]={}; return db.assignments[k];}
function ensurePath(h,p){const a=getDayAssignments(); if(!a[h]) a[h]={}; if(!Array.isArray(a[h][p])) a[h][p]=[]; return a[h][p];}
function waiterById(id){return db.waiters.find(w=>w.id===id);}
function colorForWaiter(id){const i=Math.max(0,db.waiters.findIndex(w=>w.id===id)); const [bg,fg]=CHIP_COLORS[i%CHIP_COLORS.length]; return {bg,fg};}
function banquetsForDay(){const k=dateKey(); if(!db.banquets[k]) db.banquets[k]=[]; return db.banquets[k];}
function banquetById(id){return banquetsForDay().find(b=>b.id===id);}
function notesForDay(){const k=dateKey(); if(!db.dayNotes[k]) db.dayNotes[k]={}; return db.dayNotes[k];}
function getNotes(id){const m=notesForDay(); return m[id]||(m[id]=[]);}
function addNote(id,t){const a=getNotes(id); if(!a.includes(t)) a.push(t); save();}
function delNote(id,i){const a=getNotes(id); a.splice(i,1); save();}

function addWaiter(name){
  const trimmed=(name||'').trim();
  if(!trimmed){ alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è.'); return false; }
  if(db.waiters.some(w=>w.name.toLowerCase()===trimmed.toLowerCase())){ alert('–¢–∞–∫–æ–µ –∏–º—è —É–∂–µ –µ—Å—Ç—å.'); return false; }
  db.waiters.push({id:UUID(), name:trimmed}); save(); renderWaiters(); return true;
}
function removeWaiterEverywhere(wid){
  db.waiters = db.waiters.filter(w=>w.id!==wid);
  for(const day in db.assignments){
    const halls=db.assignments[day];
    for(const hid in halls){ for(const pid in halls[hid]){ halls[hid][pid]=(halls[hid][pid]||[]).filter(e=>!(e.k==='w' && e.id===wid)); } }
  }
  for(const day in db.dayNotes){ if(db.dayNotes[day] && db.dayNotes[day][wid]) delete db.dayNotes[day][wid]; }
  if(selected && selected.k==='w' && selected.id===wid) selected=null;
  save(); renderWaiters(); renderColumns();
}

function renderWaiters(){
  waiterRow.innerHTML='';
  db.waiters.forEach(w=>{
    const chip=chipTpl.content.firstElementChild.cloneNode(true);
    chip.querySelector('.name').textContent=w.name;
    chip.querySelector('.note-dot').textContent=getNotes(w.id).length?'‚Ä¢':'';
    const {bg,fg}=colorForWaiter(w.id); chip.style.background=bg; chip.style.color=fg; chip.style.borderColor=bg;

    if(selected && selected.k==='w' && selected.id===w.id) chip.classList.add('active');

    chip.addEventListener('click',e=>{
      if(e.target.closest('.edit') || e.target.closest('.del')) return;
      selected=(selected&&selected.k==='w'&&selected.id===w.id)?null:{k:'w',id:w.id};
      renderWaiters(); renderBanquetBar();
    },{passive:true});

    chip.querySelector('.edit').addEventListener('click',e=>{ e.stopPropagation(); openCommentsModal(w.id); });
    chip.querySelector('.del').addEventListener('click',e=>{
      e.stopPropagation();
      const ok=confirm(`–£–¥–∞–ª–∏—Ç—å ¬´${w.name}¬ª –∏–∑ —Å–ø–∏—Å–∫–∞?`);
      if(ok) removeWaiterEverywhere(w.id);
    });

    waiterRow.appendChild(chip);
  });
}

const BTYPE=t=>BANQUET_TYPES[t]||BANQUET_TYPES['–î—Ä—É–≥–æ–π'];
function renderBanquetBar(){
  banquetBar.innerHTML='';
  const addBtn=document.createElement('button'); addBtn.className='b-chip b-add'; addBtn.textContent='+ –ë–∞–Ω–∫–µ—Ç';
  addBtn.addEventListener('click',()=>openBanquetModal());
  banquetBar.appendChild(addBtn);

  banquetsForDay().forEach(b=>{
    const meta=BTYPE(b.type);
    const btn=document.createElement('div'); btn.className='b-chip'; btn.setAttribute('draggable','true'); btn.style.background=meta.bg; btn.style.color=meta.fg; btn.style.borderColor=meta.bg;
    const dot=document.createElement('span'); dot.className='b-dot'; dot.style.background=meta.bg;
    const title=b.type==='–î—Ä—É–≥–æ–π'&&b.other?('–î—Ä—É–≥–æ–µ: '+b.other):meta.label;
    const txt=document.createElement('span'); txt.textContent=`${title} ¬∑ ${b.people}`;
    const actions=document.createElement('span'); actions.className='b-actions';
    const edit=document.createElement('button'); edit.className='icon-btn'; edit.textContent='‚úèÔ∏è'; edit.title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
    const del=document.createElement('button'); del.className='icon-btn'; del.textContent='üóë'; del.title='–£–¥–∞–ª–∏—Ç—å';
    edit.onclick=e=>{e.stopPropagation(); openBanquetModal(b);};
    del.onclick=e=>{e.stopPropagation(); deleteBanquet(b.id);};
    btn.appendChild(dot); btn.appendChild(txt); actions.appendChild(edit); actions.appendChild(del); btn.appendChild(actions);
    if(selected && selected.k==='b' && selected.id===b.id) btn.classList.add('active');
    btn.addEventListener('click',()=>{selected=(selected&&selected.k==='b'&&selected.id===b.id)?null:{k:'b',id:b.id}; renderBanquetBar(); renderWaiters();},{passive:true});
    btn.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',JSON.stringify({k:'b',id:b.id}));});
    banquetBar.appendChild(btn);
  });
}
function deleteBanquet(id){
  const a=banquetsForDay(); const i=a.findIndex(x=>x.id===id); if(i>-1) a.splice(i,1);
  const ass=getDayAssignments(); for(const h in ass){ for(const p in ass[h]){ ass[h][p]=(ass[h][p]||[]).filter(x=>!(x.k==='b'&&x.id===id)); } }
  if(selected && selected.k==='b' && selected.id===id) selected=null; save(); renderBanquetBar(); renderColumns();
}

function hallIcon(n){return ({'–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª':'üèõÔ∏è','–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª':'üéâ','–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã':'‚≠ê','–í–µ—Ä–∞–Ω–¥–∞':'üåø','–õ–æ—Ñ—Ç':'üß±','–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞':'üç∑'})[n]||'üè∑Ô∏è';}
function renderColumns(){
  col1.innerHTML=''; col2.innerHTML=''; col3.innerHTML='';
  const by=Object.fromEntries(db.halls.map(h=>[h.name,h]));
  const order=['–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª','–ú–∞–ª—ã–π (–±–∞–Ω–∫–µ—Ç–Ω—ã–π) –∑–∞–ª','–í–ò–ü-–∫–æ–º–Ω–∞—Ç—ã','–í–µ—Ä–∞–Ω–¥–∞','–õ–æ—Ñ—Ç','–í–∏–Ω–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞'];

  function mountHall(h,into){
    const sec=hallTpl.content.firstElementChild.cloneNode(true);
    sec.querySelector('.hall-ico').textContent=hallIcon(h.name);
    sec.querySelector('.hall-title').textContent=h.name;
    const grid=sec.querySelector('.pos-grid');
    (h.positions||[]).forEach(p=>{
      const card=posCardTpl.content.firstElementChild.cloneNode(true);
      card.querySelector('.pos-title').textContent=p.name||'';
      const counter=card.querySelector('.counter');
      const slot=card.querySelector('.slot');
      const items=ensurePath(h.id,p.id);
      drawSlot(items,slot,h.id,p.id);
      counter.textContent=`${items.length}/${SLOT_LIMIT}`;
      card.addEventListener('click',ev=>{
        if(!selected) return;
        if(ev.target.closest('.assign')) return;
        if(assignEntityWithLimit(h.id,p.id,selected)){
          const arr=ensurePath(h.id,p.id);
          counter.textContent=`${arr.length}/${SLOT_LIMIT}`;
          drawSlot(arr,slot,h.id,p.id);
        }
      },{passive:true});
      grid.appendChild(card);
    });
    into.appendChild(sec);
  }

  order.forEach((name,idx)=>{
    const h=by[name];
    if(!h) return;
    if(idx<2) mountHall(h,col1);
    else if(idx==2) mountHall(h,col2);
    else mountHall(h,col3);
  });
}

function drawSlot(items,slot,hid,pid){
  slot.innerHTML='';
  if(!items.length){
    const e=document.createElement('div'); e.className='muted'; e.textContent='‚Äî'; slot.appendChild(e);
    return;
  }
  items.forEach(ent=>{
    const el=document.createElement('div'); el.className='assign'; el.setAttribute('draggable','true');
    const dot=document.createElement('span'); dot.className='dot';
    const name=document.createElement('div'); name.className='w-name';
    const note=document.createElement('div'); note.className='w-note';
    const x=document.createElement('button'); x.className='x'; x.title='–£–¥–∞–ª–∏—Ç—å –∏–∑ –∑–æ–Ω—ã'; x.textContent='√ó';

    if(ent.k==='w'){
      const w=waiterById(ent.id), {bg}=colorForWaiter(ent.id);
      dot.style.background=bg; name.textContent=w?w.name:'‚Äî';
      const n=getNotes(ent.id); note.textContent=n&&n.length?n.join(', '):'';
    }else{
      const b=banquetById(ent.id), meta=BANQUET_TYPES[b?b.type:'–î—Ä—É–≥–æ–π'];
      dot.style.background=meta.bg;
      const t=b?(b.type==='–î—Ä—É–≥–æ–π'&&b.other?('–î—Ä—É–≥–æ–µ: '+b.other):meta.label):meta.label;
      name.textContent=b?`${t} ¬∑ ${b.people}`:meta.label;
      note.textContent=b&&b.note?b.note:'';
    }

    x.addEventListener('click',(e)=>{
      e.stopPropagation();
      removeEntity(hid,pid,ent);
      const arr=ensurePath(hid,pid);
      slot.closest('.pos-card').querySelector('.counter').textContent=`${arr.length}/${SLOT_LIMIT}`;
      drawSlot(arr,slot,hid,pid);
    });

    el.appendChild(dot); el.appendChild(name); if(note.textContent) el.appendChild(note); el.appendChild(x);

    el.addEventListener('dragstart',e=>{e.dataTransfer.setData('text/plain',JSON.stringify({k:ent.k,id:ent.id}));});
    slot.addEventListener('dragover',e=>{e.preventDefault(); slot.classList.add('highlight');});
    slot.addEventListener('dragleave',()=>slot.classList.remove('highlight'));
    slot.addEventListener('drop',e=>{
      e.preventDefault(); slot.classList.remove('highlight');
      const p=JSON.parse(e.dataTransfer.getData('text/plain')||'{}'); if(!p.k||!p.id) return;
      if(assignEntityWithLimit(hid,pid,{k:p.k,id:p.id})){
        const arr=ensurePath(hid,pid);
        slot.closest('.pos-card').querySelector('.counter').textContent=`${arr.length}/${SLOT_LIMIT}`;
        drawSlot(arr,slot,hid,pid);
      }
    });

    slot.appendChild(el);
  });
}

function assignEntityWithLimit(hid,pid,ent){
  const arr=ensurePath(hid,pid);
  if(arr.some(x=>x.k===ent.k&&x.id===ent.id)) return false;
  if(arr.length>=SLOT_LIMIT){ alert(`–õ–∏–º–∏—Ç ${SLOT_LIMIT} –≤ —ç—Ç–æ–π –ø–æ–∑–∏—Ü–∏–∏.`); return false; }
  arr.push({k:ent.k,id:ent.id}); save(); return true;
}
function removeEntity(hid,pid,ent){
  const arr=ensurePath(hid,pid); const i=arr.findIndex(x=>x.k===ent.k&&x.id===ent.id);
  if(i>-1) arr.splice(i,1); save();
}

function openCommentsModal(wid){
  const w=waiterById(wid); if(!w) return;
  const html =
    '<h3 style="margin:0">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ‚Äî '+esc(w.name)+' ('+fmtRU(dateKey())+')</h3>'+
    '<div class="presets" id="presetBox"></div>'+
    '<div class="tags" id="cList" style="margin-top:4px"></div>'+
    '<div class="row"><label>–ù–æ–≤—ã–π</label><input id="cInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –¥–æ 18:00; —Å—Ç–∞–∂—ë—Ä" /></div>'+
    '<div class="row" style="justify-content:flex-end; gap:8px"><button id="cAdd" class="btn-acc">–î–æ–±–∞–≤–∏—Ç—å</button><button id="cClose">–ó–∞–∫—Ä—ã—Ç—å</button></div>';
  openModal(html,(dlg,close)=>{
    const cList=dlg.querySelector('#cList'), cInput=dlg.querySelector('#cInput');
    const draw=()=>{ cList.innerHTML=''; getNotes(wid).forEach((t,i)=>{ const tag=document.createElement('span'); tag.className='tag'; tag.textContent=t+' '; const x=document.createElement('span'); x.className='x'; x.textContent='√ó'; x.onclick=()=>{delNote(wid,i); renderWaiters(); renderColumns(); draw();}; tag.appendChild(x); cList.appendChild(tag); }); };
    const box=dlg.querySelector('#presetBox'); box.innerHTML='';
    const cur=getNotes(wid);
    PRESET_COMMENTS.forEach(label=>{
      const b=document.createElement('button'); b.type='button'; b.className='preset'+(cur.includes(label)?' on':''); b.textContent=label;
      b.onclick=()=>{ const idx=cur.indexOf(label); if(idx===-1){addNote(wid,label);} else {delNote(wid,idx);} renderWaiters(); renderColumns(); draw(); b.classList.toggle('on'); };
      box.appendChild(b);
    });
    draw();
    dlg.querySelector('#cAdd').onclick=()=>{ const v=(cInput.value||'').trim(); if(!v) return; addNote(wid,v); cInput.value=''; renderWaiters(); renderColumns(); draw(); };
    dlg.querySelector('#cClose').onclick=close;
  });
}

function openBanquetModal(existing){
  const isEdit=!!existing;
  const html =
    `<h3 style="margin:0">${isEdit?'–ò–∑–º–µ–Ω–∏—Ç—å –±–∞–Ω–∫–µ—Ç':'–ù–æ–≤—ã–π –±–∞–Ω–∫–µ—Ç'} ‚Äî ${fmtRU(dateKey())}</h3>`+
    '<div class="row"><label>–ö–æ–ª-–≤–æ –ø–µ—Ä—Å–æ–Ω</label><input id="bnPeople" type="number" min="1" inputmode="numeric" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä, 25" /></div>'+
    '<div class="row"><label>–í–∏–¥</label><select id="bnType"><option>–î–†</option><option>–°–≤–∞–¥—å–±–∞</option><option>–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤</option><option>–ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è</option><option>–î–µ–Ω—å –ø–∞–º—è—Ç–∏</option><option>–î—Ä—É–≥–æ–π</option></select></div>'+
    '<div class="row" id="bnOtherRow" style="display:none"><label>–î—Ä—É–≥–æ–π</label><input id="bnOther" /></div>'+
    '<div class="row"><label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label><textarea id="bnNote" rows="3" placeholder="–ü–æ–∂–µ–ª–∞–Ω–∏—è, —Ç–∞–π–º–∏–Ω–≥, –∫–æ–Ω—Ç–∞–∫—Ç—ã..."></textarea></div>'+
    `<div class="row" style="justify-content:flex-end; gap:8px"><button id="bnSave" class="btn-acc">${isEdit?'–°–æ—Ö—Ä–∞–Ω–∏—Ç—å':'–î–æ–±–∞–≤–∏—Ç—å'}</button><button id="bnClose">–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
  openModal(html,(dlg,close)=>{
    const people=dlg.querySelector('#bnPeople'), type=dlg.querySelector('#bnType'), otherRow=dlg.querySelector('#bnOtherRow'), other=dlg.querySelector('#bnOther'), note=dlg.querySelector('#bnNote');
    type.onchange=()=>{ otherRow.style.display=(type.value==='–î—Ä—É–≥–æ–π')?'flex':'none'; };
    if(isEdit){ people.value=existing.people; type.value=existing.type; note.value=existing.note||''; if(existing.type==='–î—Ä—É–≥–æ–π'){ otherRow.style.display='flex'; if(other) other.value=existing.other||''; } }
    dlg.querySelector('#bnSave').onclick=()=>{
      const n=parseInt(people.value,10); if(!(n>0)) return alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ –ø–µ—Ä—Å–æ–Ω.');
      if(isEdit){ existing.people=n; existing.type=type.value; existing.other=(other&&other.value||'').trim(); existing.note=(note.value||'').trim(); }
      else{ banquetsForDay().push({ id:UUID(), people:n, type:type.value, other:(other&&other.value||'').trim(), note:(note.value||'').trim() }); }
      save(); renderBanquetBar(); renderColumns(); close();
    };
    dlg.querySelector('#bnClose').onclick=close;
  });
}

function buildShareText(){
  const d=dateKey(); const lines=['–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ‚Äî '+fmtRU(d)];
  const ass=getDayAssignments();
  db.halls.forEach(h=>{
    lines.push('\n'+h.name+':');
    (h.positions||[]).forEach(p=>{
      const arr=(ass[h.id]&&ass[h.id][p.id])||[];
      const title=p.name||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';
      if(arr.length===0){ lines.push('‚Ä¢ '+title+': ‚Äî'); return; }
      const people=arr.map(e=>{
        if(e.k==='w'){ const w=waiterById(e.id); if(!w) return '‚Äî'; const cm=getNotes(e.id); return w.name+(cm.length?' ('+cm.join(', ')+')':''); }
        const b=banquetById(e.id); if(!b) return '–ë–∞–Ω–∫–µ—Ç'; const meta=BANQUET_TYPES[b.type]; const t=b.type==='–î—Ä—É–≥–æ–π'&&b.other?('–î—Ä—É–≥–æ–µ: '+b.other):meta.label;
        return t+' ¬∑ '+b.people+(b.note?' ('+b.note+')':'');
      }).join(' | ');
      lines.push('‚Ä¢ '+title+': '+people+`  (${arr.length}/${SLOT_LIMIT})`);
    });
  });
  const bl=banquetsForDay(); if(bl.length){ lines.push('\n–ë–∞–Ω–∫–µ—Ç—ã: '+ bl.map(b=> (BANQUET_TYPES[b.type].label)+' ¬∑ '+b.people).join('; ')); }
  return lines.join('\n');
}
async function share(){
  const text=buildShareText(), title='–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ '+fmtRU(dateKey());
  try{ if(navigator.share){ await navigator.share({title,text}); return; } }catch(_){}
  try{ await navigator.clipboard.writeText(text); alert('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω. –í—Å—Ç–∞–≤—å—Ç–µ –≤ WhatsApp/Telegram.'); }
  catch(_){
    const blob=new Blob([text],{type:'text/plain'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download=title+'.txt'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }
}

function openModal(html,onMount){
  const wrap=document.createElement('div'); wrap.className='modal'; wrap.innerHTML='<div class="dialog">'+html+'</div>'; document.body.appendChild(wrap);
  function close(){ wrap.remove(); }
  wrap.addEventListener('click',e=>{ if(e.target===wrap) close(); },{passive:true});
  onMount && onMount(wrap.querySelector('.dialog'), close);
  return {close};
}

document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ selected=null; renderWaiters(); renderBanquetBar(); }});
document.getElementById('copy').addEventListener('click',async()=>{ try{ await navigator.clipboard.writeText(buildShareText()); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ.'); }catch(e){ console.error(e); }});
document.getElementById('save').addEventListener('click',()=>{ save(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); });
document.getElementById('share').addEventListener('click',share);
document.getElementById('resetDay').addEventListener('click',()=>{ if(!confirm('–û—á–∏—Å—Ç–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É?')) return; const k=dateKey(); db.assignments[k]={}; db.dayNotes[k]={}; save(); renderAll(); });
document.getElementById('hardReset').addEventListener('click',()=>{
  if(!confirm('–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–≤—Å–µ –¥–∞—Ç—ã –∏ –±–∞–Ω–∫–µ—Ç—ã)?')) return;
  localStorage.removeItem(STORAGE_KEY); location.reload();
});
document.getElementById('date').addEventListener('change',()=>renderAll());
document.getElementById('addWaiter').addEventListener('click',()=>{
  const html =
    '<h3 style="margin:0">–ù–æ–≤—ã–π –æ—Ñ–∏—Ü–∏–∞–Ω—Ç</h3>'+
    '<div class="row"><label>–ò–º—è</label><input id="wName" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –ü–∞–≤–µ–ª" /></div>'+
    '<div class="row" style="justify-content:flex-end; gap:8px"><button id="wSave" class="btn-acc">–î–æ–±–∞–≤–∏—Ç—å</button><button id="wClose">–û—Ç–º–µ–Ω–∞</button></div>';
  openModal(html,(dlg,close)=>{
    const input=dlg.querySelector('#wName');
    dlg.querySelector('#wSave').onclick=()=>{ if(addWaiter(input.value)) close(); };
    dlg.querySelector('#wClose').onclick=close;
    input.focus();
  });
});

function renderAll(){ renderWaiters(); renderBanquetBar(); renderColumns(); }
dateEl.value=todayISO(); renderAll();

if ('serviceWorker' in navigator) {
  let refreshing = false;
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    if (refreshing) return;
    refreshing = true;
    location.reload();
  });

  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.js?ver=20');
      if (reg.update) reg.update();
      reg.addEventListener('updatefound', () => {
        const nw = reg.installing;
        if (!nw) return;
        nw.addEventListener('statechange', () => {
          if (nw.state === 'installed' && navigator.serviceWorker.controller) {
            showUpdateBanner(() => nw.postMessage({type:'SKIP_WAITING'}));
          }
        });
      });
      if (reg.waiting && navigator.serviceWorker.controller) {
        showUpdateBanner(() => reg.waiting.postMessage({type:'SKIP_WAITING'}));
      }
    } catch (e) { console.error('SW registration failed:', e); }
  });

  function showUpdateBanner(apply){
    const bar=document.getElementById('upd'); const btn=document.getElementById('updBtn');
    bar.classList.add('show'); btn.onclick=apply;
  }

  document.getElementById('refreshApp').addEventListener('click', async () => {
    try {
      const regs = await navigator.serviceWorker.getRegistrations();
      await Promise.all(regs.map(r => r.unregister()));
    } catch {}
    if ('caches' in window) {
      try {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      } catch {}
    }
    location.href = location.pathname + '?v=20';
  });
}
} // boot
</script>

<script>
// no-op fallback
</script>
</body>
</html>
